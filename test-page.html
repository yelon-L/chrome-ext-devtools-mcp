<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>MCP SSE 测试</title>
  <style>
    body { font-family: monospace; padding: 20px; max-width: 1200px; margin: 0 auto; }
    h1 { color: #333; }
    .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; font-size: 14px; }
    button.primary { background: #007bff; color: white; border: none; border-radius: 4px; }
    button.primary:hover { background: #0056b3; }
    pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
    .log { max-height: 400px; overflow-y: auto; }
    .success { color: green; }
    .error { color: red; }
    .info { color: blue; }
  </style>
</head>
<body>
  <h1>🧪 Chrome DevTools MCP - SSE 测试页面</h1>
  
  <div class="section">
    <h2>状态</h2>
    <p>会话ID: <span id="sessionId">未连接</span></p>
    <p>连接状态: <span id="status">未连接</span></p>
  </div>

  <div class="section">
    <h2>操作</h2>
    <button class="primary" onclick="connect()">1. 连接 SSE</button>
    <button class="primary" onclick="initialize()">2. 初始化</button>
    <button class="primary" onclick="listExtensions()">3. 测试 list_extensions</button>
    <button onclick="clearLog()">清空日志</button>
  </div>

  <div class="section">
    <h2>结果</h2>
    <div id="result"></div>
  </div>

  <div class="section">
    <h2>日志</h2>
    <pre id="log" class="log"></pre>
  </div>

  <script>
    let eventSource = null;
    let sessionId = null;
    let messageId = 1;
    const pendingRequests = new Map();

    function log(msg, type = 'info') {
      const logEl = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[${time}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function connect() {
      if (eventSource) {
        log('已经连接', 'error');
        return;
      }

      log('正在连接 SSE...', 'info');
      eventSource = new EventSource('/sse');

      eventSource.addEventListener('endpoint', (e) => {
        const data = JSON.parse(e.data);
        sessionId = new URL(data.uri, location.href).searchParams.get('sessionId');
        document.getElementById('sessionId').textContent = sessionId;
        document.getElementById('status').textContent = '✅ 已连接';
        log('✅ SSE 连接成功, 会话ID: ' + sessionId, 'success');
      });

      eventSource.addEventListener('message', (e) => {
        const msg = JSON.parse(e.data);
        log('📥 收到: ' + JSON.stringify(msg).substring(0, 100), 'info');
        
        if (msg.id && pendingRequests.has(msg.id)) {
          const {resolve} = pendingRequests.get(msg.id);
          pendingRequests.delete(msg.id);
          resolve(msg.result);
        }
      });

      eventSource.onerror = (e) => {
        log('❌ SSE 错误', 'error');
        document.getElementById('status').textContent = '❌ 断开';
      };
    }

    async function sendRequest(method, params = {}) {
      if (!sessionId) {
        alert('请先连接 SSE');
        return null;
      }

      const id = messageId++;
      const message = {
        jsonrpc: '2.0',
        id,
        method,
        params,
      };

      log('📤 发送: ' + method, 'info');

      const res = await fetch(`/message?sessionId=${sessionId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(message),
      });

      if (!res.ok) {
        log('❌ 请求失败: ' + res.status, 'error');
        return null;
      }

      return new Promise((resolve) => {
        pendingRequests.set(id, {resolve});
        setTimeout(() => {
          if (pendingRequests.has(id)) {
            pendingRequests.delete(id);
            resolve(null);
            log('⏰ 请求超时', 'error');
          }
        }, 10000);
      });
    }

    async function initialize() {
      const result = await sendRequest('initialize', {
        protocolVersion: '2024-11-05',
        capabilities: {},
        clientInfo: {name: 'web-test', version: '1.0.0'},
      });

      if (result) {
        log('✅ 初始化成功: ' + result.serverInfo.name, 'success');
      }
    }

    async function listExtensions() {
      const startTime = Date.now();
      
      const result = await sendRequest('tools/call', {
        name: 'list_extensions',
        arguments: {},
      });

      const duration = Date.now() - startTime;

      if (result) {
        const text = result.content[0]?.text || '';
        const count = (text.match(/##/g) || []).length - 1;
        
        log(`✅ list_extensions 完成 (耗时: ${duration}ms)`, 'success');
        log(`   找到 ${count} 个扩展`, 'success');
        
        const hasHelper = text.includes('MCP Service Worker Activator');
        const hasSW = text.includes('Service Worker:');
        
        log(`   Helper Extension: ${hasHelper ? '✅' : '❌'}`, hasHelper ? 'success' : 'error');
        log(`   SW 状态显示: ${hasSW ? '✅' : '❌'}`, hasSW ? 'success' : 'error');
        
        document.getElementById('result').innerHTML = '<pre>' + text.substring(0, 1000) + '</pre>';
      } else {
        log('❌ list_extensions 失败', 'error');
      }
    }

    function clearLog() {
      document.getElementById('log').textContent = '';
    }

    // 自动提示
    log('👋 欢迎！请按顺序点击按钮：', 'info');
    log('   1. 连接 SSE', 'info');
    log('   2. 初始化', 'info');
    log('   3. 测试 list_extensions', 'info');
  </script>
</body>
</html>
