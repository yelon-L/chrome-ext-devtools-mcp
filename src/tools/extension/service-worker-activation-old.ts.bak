/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */

/**
 * Service Workeræ¿€æ´»å·¥å…·
 * ä½¿ç”¨CDP APIæ¿€æ´»Chromeæ‰©å±•çš„Service Worker
 */

import z from 'zod';

import {ExtensionHelper} from '../../extension/ExtensionHelper.js';
import {ToolCategories} from '../categories.js';
import {defineTool} from '../ToolDefinition.js';

export const activateExtensionServiceWorker = defineTool({
  name: 'activate_extension_service_worker',
  description: `æ¿€æ´»ä¸€ä¸ªæˆ–å¤šä¸ªChromeæ‰©å±•çš„Service Worker

è‡ªåŠ¨å¯¼èˆªåˆ°chrome://extensionså¹¶æ¿€æ´»æŒ‡å®šæ‰©å±•çš„Service Workerã€‚
å½“æ‰©å±•çš„SWå¤„äºInactiveçŠ¶æ€æ—¶ï¼ŒæŸäº›åŠŸèƒ½ï¼ˆå¦‚æ¶ˆæ¯ç›‘å¬ã€åå°ä»»åŠ¡ï¼‰æ— æ³•å·¥ä½œã€‚
æ­¤å·¥å…·é€šè¿‡è„šæœ¬è‡ªåŠ¨ç‚¹å‡»"service worker"æŒ‰é’®æ¥æ¿€æ´»SWã€‚

é€‚ç”¨åœºæ™¯ï¼š
- æ‰©å±•è°ƒè¯•å‰ç¡®ä¿SWå·²æ¿€æ´»
- æ‰¹é‡æ¿€æ´»å¤šä¸ªæ‰©å±•çš„SW
- è‡ªåŠ¨åŒ–æµ‹è¯•æµç¨‹ä¸­çš„ç¯å¢ƒå‡†å¤‡`,
  annotations: {
    category: ToolCategories.EXTENSION_DEBUGGING,
    readOnlyHint: false,
  },
  schema: {
    extensionId: z
      .string()
      .regex(/^[a-z]{32}$/)
      .optional()
      .describe('æ‰©å±•IDã€‚å¦‚æœä¸æä¾›ï¼Œå°†æ ¹æ®modeå‚æ•°æ¿€æ´»SW'),
    mode: z
      .enum(['single', 'all', 'inactive'])
      .optional()
      .default('inactive')
      .describe(`æ¿€æ´»æ¨¡å¼ï¼š
        - single: åªæ¿€æ´»æŒ‡å®šextensionIdçš„SWï¼ˆéœ€æä¾›extensionIdï¼‰
        - all: æ¿€æ´»æ‰€æœ‰æ‰©å±•çš„SWï¼ˆåŒ…æ‹¬å·²æ¿€æ´»çš„ï¼‰
        - inactive: åªæ¿€æ´»æœªæ¿€æ´»çš„SWï¼ˆé»˜è®¤ï¼‰`),
  },
  handler: async (request, response, context) => {
    const {extensionId, mode = 'inactive'} = request.params;

    // éªŒè¯å‚æ•°ç»„åˆ
    if (mode === 'single' && !extensionId) {
      response.appendResponseLine('# å‚æ•°é”™è¯¯\n');
      response.appendResponseLine('âŒ ä½¿ç”¨ `single` æ¨¡å¼æ—¶å¿…é¡»æä¾› `extensionId`');
      return;
    }

    try {
      // ä½¿ç”¨CDP APIæ–¹å¼æ¿€æ´»Service Worker
      const helper = new ExtensionHelper(context.getBrowser());
      const results: Array<{
        id: string;
        name: string;
        success: boolean;
        method?: string;
        error?: string;
        wasActive: boolean;
      }> = [];

      // è·å–éœ€è¦æ¿€æ´»çš„æ‰©å±•åˆ—è¡¨
      let targetExtensions: Array<{id: string; name: string; isActive: boolean}> = [];
      
      if (mode === 'single' && extensionId) {
        // å•ä¸ªæ‰©å±•æ¨¡å¼
        const isActive = await context.isServiceWorkerActive(extensionId);
        const extInfo = await context.getExtensionDetails(extensionId);
        targetExtensions = [{
          id: extensionId,
          name: extInfo?.name || 'Unknown',
          isActive
        }];
      } else {
        // æ‰¹é‡æ¨¡å¼ï¼šè·å–æ‰€æœ‰æ‰©å±•
        const extensions = await context.getExtensions(false);
        
        for (const ext of extensions) {
          const isActive = await context.isServiceWorkerActive(ext.id);
          
          // æ ¹æ®modeç­›é€‰
          if (mode === 'inactive' && isActive) {
            continue; // è·³è¿‡å·²æ¿€æ´»çš„
          }
          
          targetExtensions.push({
            id: ext.id,
            name: ext.name,
            isActive
          });
        }
      }

      // å¤„ç†æ²¡æœ‰éœ€è¦æ¿€æ´»çš„æƒ…å†µ
      if (targetExtensions.length === 0) {
        response.appendResponseLine('# Service Worker æ¿€æ´»ç»“æœ\n');
        if (mode === 'single') {
          response.appendResponseLine(`âŒ æœªæ‰¾åˆ°æ‰©å±•: \`${extensionId}\`\n`);
          response.appendResponseLine('ğŸ’¡ **æç¤º**: ä½¿ç”¨ `list_extensions` æŸ¥çœ‹æ‰€æœ‰å·²å®‰è£…çš„æ‰©å±•');
        } else {
          response.appendResponseLine(`âœ… **çŠ¶æ€**: æ‰€æœ‰æ‰©å±•çš„Service Workeréƒ½å·²æ¿€æ´»\n`);
          response.appendResponseLine(`**æ¨¡å¼**: ${mode === 'all' ? 'å…¨éƒ¨' : 'ä»…æœªæ¿€æ´»'}`);
        }
        response.setIncludePages(true);
        return;
      }

      // æ¿€æ´»ç›®æ ‡æ‰©å±•
      for (const target of targetExtensions) {
        const result = await helper.activateServiceWorker(target.id);
        
        results.push({
          id: target.id,
          name: target.name,
          success: result.success,
          method: result.method,
          error: result.error,
          wasActive: target.isActive
        });
      }

      // æ ¼å¼åŒ–è¾“å‡º
      await formatCDPResponse(response, {
        status: 'completed',
        activated: results.filter(r => r.success).length,
        total: results.length,
        mode,
        results
      }, extensionId, mode);

      response.setIncludePages(true);
    } catch (error) {
      const message = error instanceof Error ? error.message : String(error);
      response.appendResponseLine('# Service Worker æ¿€æ´»å¤±è´¥\n');
      response.appendResponseLine(`âŒ **é”™è¯¯**: ${message}\n`);
      response.appendResponseLine('**å¯èƒ½çš„åŸå› **:');
      response.appendResponseLine('- Chromeè¿æ¥æ–­å¼€');
      response.appendResponseLine('- æ‰©å±•IDä¸å­˜åœ¨');
      response.appendResponseLine('- CDPæƒé™ä¸è¶³');
      response.appendResponseLine('\n**å»ºè®®**:');
      response.appendResponseLine('- ä½¿ç”¨ `list_extensions` æŸ¥çœ‹å¯ç”¨æ‰©å±•');
      response.appendResponseLine('- æ£€æŸ¥Chrome DevToolsè¿æ¥çŠ¶æ€');
    }
  },
});

/**
 * æ ¼å¼åŒ–CDP APIå“åº”è¾“å‡º
 */
async function formatCDPResponse(
  response: any,
  result: any,
  extensionId: string | undefined,
  mode: string
) {
  response.appendResponseLine('# Service Worker æ¿€æ´»ç»“æœ\n');
  
  // æ˜¾ç¤ºæ¿€æ´»ç»Ÿè®¡
  response.appendResponseLine(`âœ… **æˆåŠŸæ¿€æ´»**: ${result.activated} / ${result.total}\n`);
  
  if (mode === 'single' && extensionId) {
    response.appendResponseLine(`**æ¨¡å¼**: å•ä¸ªæ‰©å±• (${extensionId})`);
  } else if (mode === 'all') {
    response.appendResponseLine(`**æ¨¡å¼**: å…¨éƒ¨æ‰©å±•`);
  } else {
    response.appendResponseLine(`**æ¨¡å¼**: ä»…æœªæ¿€æ´»çš„æ‰©å±•`);
  }

  // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
  if (result.results && result.results.length > 0) {
    response.appendResponseLine('\n## æ¿€æ´»è¯¦æƒ…\n');
    
    for (const item of result.results) {
      const statusIcon = item.success ? 'âœ…' : 'âŒ';
      const stateLabel = item.wasActive ? '(å·²æ¿€æ´»)' : '(æœªæ¿€æ´»â†’æ¿€æ´»ä¸­)';
      
      response.appendResponseLine(`${statusIcon} **${item.name}**`);
      response.appendResponseLine(`   - ID: \`${item.id}\``);
      response.appendResponseLine(`   - çŠ¶æ€: ${stateLabel}`);
      
      if (item.success) {
        if (item.method) {
          response.appendResponseLine(`   - æ¿€æ´»æ–¹æ³•: ${item.method}`);
        }
      } else if (item.error) {
        response.appendResponseLine(`   - é”™è¯¯: ${item.error}`);
      }
      
      response.appendResponseLine('');
    }
  }

  // æ·»åŠ æç¤ºä¿¡æ¯
  if (result.activated > 0) {
    response.appendResponseLine('\n**æ³¨æ„äº‹é¡¹**:');
    response.appendResponseLine('- Service Workeræ¿€æ´»åå¯èƒ½éœ€è¦çŸ­æš‚å»¶è¿Ÿæ‰èƒ½å®Œå…¨å°±ç»ª');
    response.appendResponseLine('- ä½¿ç”¨ `list_extension_contexts` å¯æŸ¥çœ‹å½“å‰æ‰©å±•ä¸Šä¸‹æ–‡çŠ¶æ€');
    response.appendResponseLine('- ä½¿ç”¨ `get_extension_logs` å¯æŸ¥çœ‹SWçš„å¯åŠ¨æ—¥å¿—');
  }
}

/* 
 * æ³¨é‡Šï¼šæ—§çš„UIè„šæœ¬æ–¹å¼å·²åºŸå¼ƒ
 * åŸå› ï¼šchrome://extensions ä½¿ç”¨å¤šå±‚Shadow DOMï¼ŒUIæ“ä½œä¸å¯é 
 * æ–°æ–¹æ¡ˆï¼šä½¿ç”¨CDP API (ExtensionHelper.activateServiceWorker)
 */
        
        // 1. æ£€æŸ¥æ˜¯å¦åœ¨æ‰©å±•ç®¡ç†é¡µ
        if (!window.location.href.includes('chrome://extensions')) {
          window.location.href = 'chrome://extensions';
          return { 
            status: 'navigating',
            message: 'æ­£åœ¨è·³è½¬åˆ°chrome://extensions...',
            retry: true 
          };
        }

        // 2. æŸ¥æ‰¾æ‰€æœ‰æ‰©å±•é¡¹ï¼ˆéœ€è¦ç©¿é€Shadow DOMï¼‰
        let extensionItems = [];
        
        // æ–¹æ³•1: å°è¯•ç©¿é€Shadow DOMï¼ˆChromeä½¿ç”¨Shadow DOMï¼‰
        const manager = document.querySelector('extensions-manager');
        if (manager && manager.shadowRoot) {
          const itemList = manager.shadowRoot.querySelector('extensions-item-list');
          if (itemList && itemList.shadowRoot) {
            extensionItems = itemList.shadowRoot.querySelectorAll('extensions-item');
          }
        }
        
        // æ–¹æ³•2: ç›´æ¥æŸ¥è¯¢ï¼ˆæ—§ç‰ˆChromeæˆ–æœªä½¿ç”¨Shadow DOMï¼‰
        if (extensionItems.length === 0) {
          extensionItems = document.querySelectorAll('extensions-item');
        }
        
        if (extensionItems.length === 0) {
          return {
            status: 'error',
            message: 'æœªæ‰¾åˆ°ä»»ä½•æ‰©å±•',
            hint: 'è¯·ç¡®ä¿Chromeå·²å®‰è£…æ‰©å±•ï¼Œå¹¶ä¸”é¡µé¢å·²å®Œå…¨åŠ è½½',
            debug: {
              hasManager: !!document.querySelector('extensions-manager'),
              hasManagerShadowRoot: !!(manager && manager.shadowRoot),
              pageUrl: window.location.href
            }
          };
        }

        // 3. æ ¹æ®modeå‚æ•°ç­›é€‰ç›®æ ‡æ‰©å±•
        const targets = [];
        extensionItems.forEach(item => {
          const id = item.getAttribute('id');
          
          // æŸ¥æ‰¾åç§°ï¼ˆå¯èƒ½åœ¨Shadow DOMä¸­ï¼‰
          let nameEl = item.querySelector('#name');
          if (!nameEl && item.shadowRoot) {
            nameEl = item.shadowRoot.querySelector('#name');
          }
          const name = nameEl ? nameEl.textContent.trim() : 'Unknown';
          
          // æŸ¥æ‰¾Service WorkeræŒ‰é’®ï¼ˆå¯èƒ½åœ¨Shadow DOMä¸­ï¼‰
          let swButton = null;
          
          // å°è¯•åœ¨ä¸»DOMä¸­æŸ¥æ‰¾
          swButton = item.querySelector('#service-worker-button');
          if (!swButton) {
            swButton = item.querySelector('[id*="service-worker"]');
          }
          
          // å°è¯•åœ¨Shadow DOMä¸­æŸ¥æ‰¾
          if (!swButton && item.shadowRoot) {
            swButton = item.shadowRoot.querySelector('#service-worker-button');
            if (!swButton) {
              swButton = item.shadowRoot.querySelector('[id*="service-worker"]');
            }
            if (!swButton) {
              const buttons = item.shadowRoot.querySelectorAll('button');
              for (const btn of buttons) {
                if (btn.textContent.toLowerCase().includes('service worker')) {
                  swButton = btn;
                  break;
                }
              }
            }
          }
          
          // é™çº§ï¼šæ–‡æœ¬åŒ¹é…
          if (!swButton) {
            const buttons = item.querySelectorAll('button');
            for (const btn of buttons) {
              if (btn.textContent.toLowerCase().includes('service worker')) {
                swButton = btn;
                break;
              }
            }
          }
          
          if (!swButton) {
            return; // æ²¡æœ‰SWæŒ‰é’®ï¼Œè·³è¿‡æ­¤æ‰©å±•
          }
          
          const buttonText = swButton.textContent || '';
          const isActive = !buttonText.toLowerCase().includes('inactive');
          
          // æ ¹æ®modeå’ŒextensionIdç­›é€‰
          if (mode === 'single') {
            if (id !== extensionId) return;
          } else if (mode === 'inactive') {
            if (isActive) return;
          }
          // mode === 'all' æ—¶ä¸è¿‡æ»¤
          
          targets.push({ 
            id, 
            name, 
            button: swButton, 
            isActive,
            buttonText: buttonText.trim()
          });
        });

        // å¤„ç†æœªæ‰¾åˆ°æŒ‡å®šæ‰©å±•çš„æƒ…å†µ
        if (mode === 'single' && targets.length === 0) {
          return {
            status: 'error',
            message: \`æœªæ‰¾åˆ°æŒ‡å®šçš„æ‰©å±•\`,
            extensionId: extensionId,
            hint: 'è¯·æ£€æŸ¥extensionIdæ˜¯å¦æ­£ç¡®ï¼Œæˆ–ä½¿ç”¨list_extensionså·¥å…·æŸ¥çœ‹å¯ç”¨æ‰©å±•'
          };
        }

        // å¤„ç†æ²¡æœ‰éœ€è¦æ¿€æ´»çš„SWçš„æƒ…å†µ
        if (targets.length === 0) {
          return {
            status: 'completed',
            activated: 0,
            total: 0,
            message: mode === 'inactive' 
              ? 'æ‰€æœ‰æ‰©å±•çš„Service Workeréƒ½å·²æ¿€æ´»' 
              : 'æ²¡æœ‰æ‰¾åˆ°éœ€è¦æ¿€æ´»çš„Service Worker'
          };
        }

        // 4. æ¿€æ´»ç›®æ ‡SW
        const results = [];
        for (const target of targets) {
          try {
            target.button.click();
            results.push({
              id: target.id,
              name: target.name,
              success: true,
              wasActive: target.isActive,
              buttonText: target.buttonText
            });
          } catch (error) {
            results.push({
              id: target.id,
              name: target.name,
              success: false,
              error: error.message,
              wasActive: target.isActive
            });
          }
        }

        // 5. è¿”å›ç»“æœ
        return {
          status: 'completed',
          activated: results.filter(r => r.success).length,
          total: targets.length,
          mode: mode,
          results: results
        };
      })();
    `;

    try {
      // æ‰§è¡Œæ¿€æ´»è„šæœ¬
      const result = await page.evaluate(activationScript) as any;

      // å¤„ç†éœ€è¦é‡è¯•çš„æƒ…å†µï¼ˆé¡µé¢å¯¼èˆªï¼‰
      if (result?.retry) {
        response.appendResponseLine('# Service Worker æ¿€æ´»\n');
        response.appendResponseLine(`ğŸ“ ${result.message}`);
        response.appendResponseLine('\nç­‰å¾…é¡µé¢åŠ è½½...\n');
        
        // ç­‰å¾…å¯¼èˆªå®Œæˆ
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // é‡è¯•æ‰§è¡Œ
        const retryResult = await page.evaluate(activationScript) as any;
        await formatResponse(response, retryResult, extensionId, mode);
      } else {
        await formatResponse(response, result, extensionId, mode);
      }

      response.setIncludePages(true);
    } catch (error) {
      const message = error instanceof Error ? error.message : String(error);
      response.appendResponseLine('# Service Worker æ¿€æ´»å¤±è´¥\n');
      response.appendResponseLine(`âŒ **é”™è¯¯**: ${message}\n`);
      response.appendResponseLine('**å¯èƒ½çš„åŸå› **:');
      response.appendResponseLine('- Chromeç‰ˆæœ¬ä¸å…¼å®¹ï¼ˆDOMç»“æ„å˜åŒ–ï¼‰');
      response.appendResponseLine('- é¡µé¢åŠ è½½æœªå®Œæˆ');
      response.appendResponseLine('- æ‰©å±•ç®¡ç†é¡µé¢ç»“æ„å·²å˜æ›´');
      response.appendResponseLine('\n**å»ºè®®**:');
      response.appendResponseLine('- æ‰‹åŠ¨è®¿é—® chrome://extensions æ£€æŸ¥é¡µé¢');
      response.appendResponseLine('- å°è¯•åˆ·æ–°é¡µé¢åé‡è¯•');
    }
  },
});

/**
 * æ ¼å¼åŒ–å“åº”è¾“å‡º
 */
async function formatResponse(
  response: any,
  result: any,
  extensionId: string | undefined,
  mode: string
) {
  if (result.status === 'error') {
    response.appendResponseLine('# Service Worker æ¿€æ´»å¤±è´¥\n');
    response.appendResponseLine(`âŒ **é”™è¯¯**: ${result.message}\n`);
    if (result.extensionId) {
      response.appendResponseLine(`**Extension ID**: ${result.extensionId}`);
    }
    if (result.hint) {
      response.appendResponseLine(`\nğŸ’¡ **æç¤º**: ${result.hint}`);
    }
    return;
  }

  response.appendResponseLine('# Service Worker æ¿€æ´»ç»“æœ\n');
  
  // æ˜¾ç¤ºæ¿€æ´»ç»Ÿè®¡
  response.appendResponseLine(`âœ… **æˆåŠŸæ¿€æ´»**: ${result.activated} / ${result.total}\n`);
  
  if (mode === 'single' && extensionId) {
    response.appendResponseLine(`**æ¨¡å¼**: å•ä¸ªæ‰©å±• (${extensionId})`);
  } else if (mode === 'all') {
    response.appendResponseLine(`**æ¨¡å¼**: å…¨éƒ¨æ‰©å±•`);
  } else {
    response.appendResponseLine(`**æ¨¡å¼**: ä»…æœªæ¿€æ´»çš„æ‰©å±•`);
  }

  // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
  if (result.results && result.results.length > 0) {
    response.appendResponseLine('\n## æ¿€æ´»è¯¦æƒ…\n');
    
    for (const item of result.results) {
      const statusIcon = item.success ? 'âœ…' : 'âŒ';
      const stateLabel = item.wasActive ? '(å·²æ¿€æ´»)' : '(æœªæ¿€æ´»â†’æ¿€æ´»)';
      
      response.appendResponseLine(`${statusIcon} **${item.name}**`);
      response.appendResponseLine(`   - ID: \`${item.id}\``);
      response.appendResponseLine(`   - çŠ¶æ€: ${stateLabel}`);
      
      if (!item.success && item.error) {
        response.appendResponseLine(`   - é”™è¯¯: ${item.error}`);
      }
      
      if (item.buttonText) {
        response.appendResponseLine(`   - æŒ‰é’®æ–‡æœ¬: "${item.buttonText}"`);
      }
      
      response.appendResponseLine('');
    }
  } else if (result.message) {
    response.appendResponseLine(`\n${result.message}`);
  }

  // æ·»åŠ æç¤ºä¿¡æ¯
  if (result.activated > 0) {
    response.appendResponseLine('\n**æ³¨æ„äº‹é¡¹**:');
    response.appendResponseLine('- Service Workeræ¿€æ´»åå¯èƒ½éœ€è¦çŸ­æš‚å»¶è¿Ÿæ‰èƒ½å®Œå…¨å°±ç»ª');
    response.appendResponseLine('- ä½¿ç”¨ `list_extension_contexts` å¯æŸ¥çœ‹å½“å‰æ‰©å±•ä¸Šä¸‹æ–‡çŠ¶æ€');
    response.appendResponseLine('- ä½¿ç”¨ `get_extension_logs` å¯æŸ¥çœ‹SWçš„å¯åŠ¨æ—¥å¿—');
  }
}
