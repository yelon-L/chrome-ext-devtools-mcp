#!/usr/bin/env node

/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */

/**
 * è‡ªåŠ¨ç”Ÿæˆæ•°æ®åº“è¡Œæ˜ å°„å‡½æ•°
 * 
 * ä½¿ç”¨æ–¹å¼:
 *   npm run generate-mappers
 */

import fs from 'node:fs';
import path from 'node:path';
import {fileURLToPath} from 'node:url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

/**
 * è¡¨æ˜ å°„é…ç½®
 */
interface TableMapping {
  tableName: string;           // æ•°æ®åº“è¡¨å
  typeName: string;            // TypeScript ç±»å‹å
  recordType: string;          // ä¸šåŠ¡å¯¹è±¡ç±»å‹
  columns: ColumnMapping[];
}

/**
 * åˆ—æ˜ å°„é…ç½®
 */
interface ColumnMapping {
  dbName: string;              // æ•°æ®åº“åˆ—å
  tsName: string;              // TypeScript å±æ€§å
  type: 'string' | 'number' | 'boolean' | 'json' | 'timestamp' | 'bigint';
  nullable: boolean;
  transform?: string;          // è‡ªå®šä¹‰è½¬æ¢å‡½æ•°
}

/**
 * è¡¨æ˜ å°„é…ç½®
 * 
 * æ·»åŠ æ–°è¡¨æ—¶ï¼Œåœ¨è¿™é‡Œé…ç½®æ˜ å°„è§„åˆ™
 */
const TABLE_MAPPINGS: TableMapping[] = [
  {
    tableName: 'mcp_users',
    typeName: 'UsersTable',
    recordType: 'UserRecordV2',
    columns: [
      {dbName: 'user_id', tsName: 'userId', type: 'string', nullable: false},
      {dbName: 'email', tsName: 'email', type: 'string', nullable: false},
      {dbName: 'username', tsName: 'username', type: 'string', nullable: false},
      {dbName: 'registered_at', tsName: 'registeredAt', type: 'bigint', nullable: false},
      {dbName: 'updated_at', tsName: 'updatedAt', type: 'bigint', nullable: true},
      {dbName: 'metadata', tsName: 'metadata', type: 'json', nullable: true},
    ],
  },
  {
    tableName: 'mcp_browsers',
    typeName: 'BrowsersTable',
    recordType: 'BrowserRecordV2',
    columns: [
      {dbName: 'browser_id', tsName: 'browserId', type: 'string', nullable: false},
      {dbName: 'user_id', tsName: 'userId', type: 'string', nullable: false},
      {dbName: 'browser_url', tsName: 'browserURL', type: 'string', nullable: false},
      {dbName: 'token_name', tsName: 'tokenName', type: 'string', nullable: false},
      {dbName: 'token', tsName: 'token', type: 'string', nullable: false},
      {dbName: 'created_at_ts', tsName: 'createdAt', type: 'bigint', nullable: false},
      {dbName: 'last_connected_at', tsName: 'lastConnectedAt', type: 'bigint', nullable: true},
      {dbName: 'tool_call_count', tsName: 'toolCallCount', type: 'number', nullable: false},
      {dbName: 'metadata', tsName: 'metadata', type: 'json', nullable: true},
    ],
  },
];

/**
 * ç”Ÿæˆåˆ—è½¬æ¢ä»£ç 
 */
function generateColumnTransform(col: ColumnMapping): string {
  const accessor = `row.${col.dbName}`;
  
  // è‡ªå®šä¹‰è½¬æ¢
  if (col.transform) {
    return col.transform.replace('$value', accessor);
  }
  
  // æ ‡å‡†è½¬æ¢
  let transform = accessor;
  
  switch (col.type) {
    case 'number':
      transform = `Number(${accessor})`;
      break;
    case 'bigint':
      // BigInt éœ€è½¬ä¸º number
      transform = `Number(${accessor})`;
      break;
    case 'json':
      // JSONB åœ¨ pg é©±åŠ¨ä¸­å·²è§£æä¸ºå¯¹è±¡ï¼Œä¸éœ€è¦ JSON.parse
      transform = accessor;
      break;
    case 'timestamp':
      transform = `new Date(${accessor})`;
      break;
  }
  
  // å¤„ç†å¯ç©ºå­—æ®µ
  if (col.nullable) {
    return `${accessor} ? ${transform} : undefined`;
  }
  
  return transform;
}

/**
 * ç”Ÿæˆå•ä¸ª mapper å‡½æ•°ï¼ˆDB Row â†’ ä¸šåŠ¡å¯¹è±¡ï¼‰
 */
function generateRowMapper(mapping: TableMapping): string {
  const functionName = `map${toPascalCase(mapping.tableName.replace('mcp_', ''))}Row`;
  
  return `
/**
 * å°†æ•°æ®åº“è¡Œæ˜ å°„ä¸ºä¸šåŠ¡å¯¹è±¡
 * @auto-generated - DO NOT EDIT MANUALLY
 */
export function ${functionName}(row: any): ${mapping.recordType} {
  return {
${mapping.columns.map(col => 
  `    ${col.tsName}: ${generateColumnTransform(col)},`
).join('\n')}
  };
}
`;
}

/**
 * å°† snake_case è½¬ä¸º PascalCase
 */
function toPascalCase(str: string): string {
  return str
    .split('_')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join('');
}

/**
 * ç”Ÿæˆå®Œæ•´æ–‡ä»¶å†…å®¹
 */
function generateFile(): string {
  const header = `/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */

/**
 * æ•°æ®åº“è¡Œæ˜ å°„å‡½æ•°
 * 
 * @auto-generated by scripts/generate-mappers.ts
 * DO NOT EDIT THIS FILE MANUALLY
 * 
 * ç”Ÿæˆæ—¶é—´: ${new Date().toISOString()}
 */

import type {UserRecordV2, BrowserRecordV2} from './PersistentStoreV2.js';

`;

  const mappers = TABLE_MAPPINGS.map(mapping => generateRowMapper(mapping)).join('\n');
  
  return header + mappers;
}

/**
 * ä¸»å‡½æ•°
 */
function main() {
  try {
    const outputPath = path.join(
      __dirname,
      '../src/multi-tenant/storage/mappers.generated.ts'
    );
    
    const code = generateFile();
    
    fs.writeFileSync(outputPath, code, 'utf-8');
    
    console.log('âœ… æˆåŠŸç”Ÿæˆæ˜ å°„å‡½æ•°:', outputPath);
    console.log(`ğŸ“Š ç”Ÿæˆäº† ${TABLE_MAPPINGS.length} ä¸ªè¡¨çš„æ˜ å°„å‡½æ•°`);
  } catch (error) {
    console.error('âŒ ç”Ÿæˆå¤±è´¥:', error);
    process.exit(1);
  }
}

// æ‰§è¡Œ
main();
