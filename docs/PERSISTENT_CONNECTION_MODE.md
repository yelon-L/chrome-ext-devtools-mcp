# æŒä¹…è¿æ¥æ¨¡å¼ (Persistent Connection Mode)

**ç‰ˆæœ¬**: v0.8.11  
**åˆ›å»ºæ—¶é—´**: 2025-10-17  
**é€‚ç”¨æ¨¡å¼**: SSE / Streamable / Multi-Tenant

---

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

### åŸæœ‰è¶…æ—¶æœºåˆ¶çš„é—®é¢˜

åœ¨é»˜è®¤é…ç½®ä¸‹ï¼ŒMCPæœåŠ¡ä¼šåœ¨ä»¥ä¸‹æƒ…å†µ**ä¸»åŠ¨æ–­å¼€IDEå®¢æˆ·ç«¯è¿æ¥**ï¼š

```
æ¯60ç§’æ£€æŸ¥ä¸€æ¬¡
  â†“
å‘ç°ä¼šè¯è¶…è¿‡1å°æ—¶æ— æ´»åŠ¨
  â†“
è°ƒç”¨ transport.close()
  â†“
IDEå®¢æˆ·ç«¯è¢«æ–­å¼€ âŒ
```

**è§¦å‘æ¡ä»¶**ï¼š

- é»˜è®¤è¶…æ—¶ï¼š1å°æ—¶ï¼ˆ3600000msï¼‰
- åˆ¤å®šæ ‡å‡†ï¼š`lastActivity` æœªæ›´æ–°
- æ´»åŠ¨æ¥æºï¼šä»…å·¥å…·è°ƒç”¨ä¼šæ›´æ–°ï¼ˆSSEå¿ƒè·³åŒ…ä¸ä¼šæ›´æ–°ï¼‰

**å½±å“**ï¼š

- IDEåœ¨é•¿æ—¶é—´ä¸æ“ä½œåæ— æ³•ç»§ç»­ä½¿ç”¨
- ç”¨æˆ·éœ€è¦é‡æ–°è¿æ¥æ‰èƒ½æ¢å¤æœåŠ¡
- å•å®¢æˆ·ç«¯åœºæ™¯ä¸‹çš„ç”¨æˆ·ä½“éªŒæå·®

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æŒä¹…è¿æ¥æ¨¡å¼

å¼•å…¥ `persistent` æ ‡å¿—ï¼Œæ ‡è®°ä¸ºæŒä¹…è¿æ¥çš„ä¼šè¯**æ°¸ä¸è¶…æ—¶**ï¼š

```typescript
interface Session {
  sessionId: string;
  userId: string;
  // ...
  lastActivity: Date;
  persistent?: boolean; // ğŸ”‘ æ–°å¢å­—æ®µ
}
```

### æ™ºèƒ½é»˜è®¤è¡Œä¸º

```typescript
// é»˜è®¤é€»è¾‘
persistentMode = !MAX_SESSIONS || PERSISTENT_MODE === 'true';
```

**è§„åˆ™**ï¼š

1. **æœªè®¾ç½® `MAX_SESSIONS`** â†’ è‡ªåŠ¨å¯ç”¨æŒä¹…æ¨¡å¼ï¼ˆå•å®¢æˆ·ç«¯åœºæ™¯ï¼‰
2. **è®¾ç½®äº† `MAX_SESSIONS`** â†’ è‡ªåŠ¨ç¦ç”¨æŒä¹…æ¨¡å¼ï¼ˆå¤šç§Ÿæˆ·åœºæ™¯ï¼‰
3. **æ˜¾å¼è®¾ç½® `PERSISTENT_MODE`** â†’ è¦†ç›–è‡ªåŠ¨åˆ¤æ–­

---

## ğŸ”§ é…ç½®æ–¹å¼

### æ–¹æ³•1ï¼šä¾èµ–é»˜è®¤è¡Œä¸ºï¼ˆæ¨èï¼‰

```bash
# ä¸è®¾ç½® MAX_SESSIONSï¼Œè‡ªåŠ¨å¯ç”¨æŒä¹…æ¨¡å¼
node build/src/server-sse.js

# è¾“å‡ºæ—¥å¿—
ğŸ“‹ Configuration:
   Session: timeout=3600000ms, cleanup=60000ms, persistent=true
```

### æ–¹æ³•2ï¼šæ˜¾å¼å¯ç”¨

```bash
# .env æ–‡ä»¶
PERSISTENT_MODE=true

# æˆ–ç¯å¢ƒå˜é‡
export PERSISTENT_MODE=true
node build/src/multi-tenant/server-multi-tenant.js
```

### æ–¹æ³•3ï¼šå¤šç§Ÿæˆ·åœºæ™¯ç¦ç”¨

```bash
# è®¾ç½®æœ€å¤§ä¼šè¯æ•°ï¼Œè‡ªåŠ¨ç¦ç”¨æŒä¹…æ¨¡å¼
MAX_SESSIONS=100

# è¾“å‡ºæ—¥å¿—
ğŸ“‹ Configuration:
   Session: timeout=3600000ms, cleanup=60000ms, persistent=false
     - maxSessions: 100
```

---

## ğŸ” å·¥ä½œåŸç†

### 1. ä¼šè¯åˆ›å»º

```typescript
// SessionManager.ts
createSession(...): Session {
  const session: Session = {
    // ...
    persistent: this.#config.persistentMode,  // ç»§æ‰¿å…¨å±€é…ç½®
  };

  this.#logger.info('ä¼šè¯å·²åˆ›å»º', {
    sessionId,
    userId,
    persistent: session.persistent  // æ—¥å¿—è®°å½•
  });
}
```

### 2. æ¸…ç†é€»è¾‘

```typescript
// SessionManager.ts
async cleanupExpiredSessions(): Promise<void> {
  for (const [sessionId, session] of this.#sessions) {
    // ğŸ”‘ è·³è¿‡æŒä¹…è¿æ¥ä¼šè¯
    if (session.persistent) {
      skippedPersistent++;
      continue;
    }

    const inactive = now - session.lastActivity.getTime();
    if (inactive > this.#config.timeout) {
      expiredSessions.push(sessionId);
    }
  }

  // æ—¥å¿—è¾“å‡ºè·³è¿‡çš„æŒä¹…ä¼šè¯æ•°
  this.#logger.info('æ¸…ç†è¿‡æœŸä¼šè¯', {
    count: expiredSessions.length,
    persistent: skippedPersistent
  });
}
```

### 3. ç›‘æ§æ—¥å¿—

```bash
# ä¼šè¯åˆ›å»º
[SessionManager] ä¼šè¯å·²åˆ›å»º {"sessionId":"sess_abc","userId":"user123","persistent":true}

# æ¸…ç†æ£€æŸ¥ï¼ˆæ¯åˆ†é’Ÿï¼‰
[SessionManager] è·³è¿‡æŒä¹…è¿æ¥ä¼šè¯æ¸…ç† {"persistent":1}

# æ¸…ç†æ‰§è¡Œ
[SessionManager] æ¸…ç†è¿‡æœŸä¼šè¯ {"count":3,"persistent":1}
```

---

## ğŸ“Š ä½¿ç”¨åœºæ™¯

### âœ… é€‚ç”¨åœºæ™¯ï¼šå¯ç”¨æŒä¹…æ¨¡å¼

| åœºæ™¯               | åŸå›                    |
| ------------------ | ---------------------- |
| **å•å®¢æˆ·ç«¯IDE**    | é¿å…é•¿æ—¶é—´ä¸æ“ä½œåæ–­è¿ |
| **SSEæ¨¡å¼**        | å•ç”¨æˆ·å¼€å‘ç¯å¢ƒ         |
| **Streamableæ¨¡å¼** | å•ç”¨æˆ·å¼€å‘ç¯å¢ƒ         |
| **æœ¬åœ°å¼€å‘**       | æ— éœ€ä¼šè¯é™åˆ¶           |

### âš ï¸ ä¸é€‚ç”¨åœºæ™¯ï¼šç¦ç”¨æŒä¹…æ¨¡å¼

| åœºæ™¯                      | åŸå›                  |
| ------------------------- | -------------------- |
| **å¤šç§Ÿæˆ·ç”Ÿäº§ç¯å¢ƒ**        | éœ€è¦å®šæœŸæ¸…ç†åƒµå°¸ä¼šè¯ |
| **å…¬å…±æœåŠ¡**              | é˜²æ­¢èµ„æºè€—å°½         |
| **è®¾ç½®äº† `MAX_SESSIONS`** | éœ€è¦ä¼šè¯æ•°é‡æ§åˆ¶     |

---

## ğŸ§ª éªŒè¯æ–¹æ³•

### 1. æ£€æŸ¥é…ç½®

```bash
# å¯åŠ¨æœåŠ¡ï¼ŒæŸ¥çœ‹é…ç½®è¾“å‡º
node build/src/multi-tenant/server-multi-tenant.js

# è¾“å‡ºç¤ºä¾‹ï¼ˆå·²å¯ç”¨ï¼‰
ğŸ“‹ Configuration:
   Session: timeout=3600000ms, cleanup=60000ms, persistent=true

# è¾“å‡ºç¤ºä¾‹ï¼ˆå·²ç¦ç”¨ï¼‰
ğŸ“‹ Configuration:
   Session: timeout=3600000ms, cleanup=60000ms, persistent=false
     - maxSessions: 100
```

### 2. å¥åº·æ£€æŸ¥

```bash
curl http://localhost:32122/health | jq '.sessions'
```

**è¾“å‡ºç¤ºä¾‹**ï¼š

```json
{
  "total": 2,
  "active": 2,
  "byUser": {
    "user123": 1
  }
}
```

### 3. è§‚å¯Ÿæ—¥å¿—

```bash
# æŒä¹…æ¨¡å¼ï¼šä¸ä¼šçœ‹åˆ°ä¼šè¯è¢«æ¸…ç†
[SessionManager] è·³è¿‡æŒä¹…è¿æ¥ä¼šè¯æ¸…ç† {"persistent":1}

# æ™®é€šæ¨¡å¼ï¼šä¼šçœ‹åˆ°å®šæœŸæ¸…ç†
[SessionManager] æ¸…ç†è¿‡æœŸä¼šè¯ {"count":2,"persistent":0}
[SessionManager] ä¼šè¯å·²åˆ é™¤ {"sessionId":"sess_xyz"}
```

---

## âš™ï¸ ç¯å¢ƒå˜é‡å‚è€ƒ

```bash
# æ˜¾å¼å¯ç”¨æŒä¹…æ¨¡å¼
PERSISTENT_MODE=true

# æ˜¾å¼ç¦ç”¨æŒä¹…æ¨¡å¼
PERSISTENT_MODE=false

# å¤šç§Ÿæˆ·æ¨¡å¼ï¼ˆè‡ªåŠ¨ç¦ç”¨æŒä¹…æ¨¡å¼ï¼‰
MAX_SESSIONS=100

# ä¸è®¾ç½® MAX_SESSIONSï¼ˆè‡ªåŠ¨å¯ç”¨æŒä¹…æ¨¡å¼ï¼‰
# MAX_SESSIONS=
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### å¼€å‘ç¯å¢ƒï¼ˆæ¨èå¯ç”¨ï¼‰

```bash
# .env
# ä¸è®¾ç½® MAX_SESSIONSï¼Œè‡ªåŠ¨å¯ç”¨æŒä¹…æ¨¡å¼
SESSION_TIMEOUT=3600000
SESSION_CLEANUP_INTERVAL=60000
```

### ç”Ÿäº§ç¯å¢ƒï¼ˆå¤šç§Ÿæˆ·ï¼‰

```bash
# .env
MAX_SESSIONS=100         # é™åˆ¶æœ€å¤§ä¼šè¯æ•°
SESSION_TIMEOUT=1800000  # 30åˆ†é’Ÿè¶…æ—¶
PERSISTENT_MODE=false    # ç¦ç”¨æŒä¹…æ¨¡å¼
```

### å•ç”¨æˆ·ç”Ÿäº§ç¯å¢ƒ

```bash
# .env
PERSISTENT_MODE=true     # æ˜¾å¼å¯ç”¨
SESSION_TIMEOUT=86400000 # è®¾ç½®ä¸º24å°æ—¶ï¼ˆè™½ç„¶ä¸ä¼šç”Ÿæ•ˆï¼‰
```

---

## ğŸ”„ ä¸åŸæœ‰æœºåˆ¶çš„å¯¹æ¯”

| ç‰¹æ€§         | åŸæœ‰æœºåˆ¶            | æŒä¹…è¿æ¥æ¨¡å¼      |
| ------------ | ------------------- | ----------------- |
| **è¶…æ—¶æ–­è¿** | âœ… 1å°æ—¶åæ–­å¼€      | âŒ æ°¸ä¸æ–­å¼€       |
| **ä¼šè¯æ¸…ç†** | âœ… å®šæœŸæ¸…ç†è¿‡æœŸä¼šè¯ | âœ… è·³è¿‡æŒä¹…ä¼šè¯   |
| **èµ„æºç®¡ç†** | âš ï¸ åƒµå°¸ä¼šè¯ç´¯ç§¯     | âœ… æŒä¹…ä¼šè¯å—ä¿æŠ¤ |
| **ç”¨æˆ·ä½“éªŒ** | âš ï¸ éœ€è¦é‡è¿         | âœ… æ— ç¼ä½¿ç”¨       |
| **é€‚ç”¨åœºæ™¯** | å¤šç§Ÿæˆ·              | å•å®¢æˆ·ç«¯          |

---

## ğŸš¨ æ³¨æ„äº‹é¡¹

### 1. å†…å­˜ç®¡ç†

æŒä¹…è¿æ¥ä¼šè¯**ä¸ä¼šè‡ªåŠ¨é‡Šæ”¾**ï¼Œéœ€è¦ï¼š

- IDEä¸»åŠ¨å…³é—­è¿æ¥
- æœåŠ¡å™¨é‡å¯
- æ‰‹åŠ¨æ¸…ç†

### 2. åƒµå°¸è¿æ¥

å¦‚æœIDEæ„å¤–å´©æºƒï¼š

- æŒä¹…ä¼šè¯ä¼šä¿ç•™åœ¨å†…å­˜ä¸­
- æµè§ˆå™¨è¿æ¥ä¼šä¿æŒ
- éœ€è¦æ‰‹åŠ¨é‡å¯æœåŠ¡æ¸…ç†

**è§£å†³æ–¹æ¡ˆ**ï¼šç›‘å¬SSE `onclose` äº‹ä»¶

```typescript
transport.onclose = () => {
  sessionManager.deleteSession(sessionId);
};
```

### 3. å¤šç§Ÿæˆ·é£é™©

åœ¨å¤šç§Ÿæˆ·åœºæ™¯ä¸‹å¯ç”¨æŒä¹…æ¨¡å¼ä¼šå¯¼è‡´ï¼š

- âŒ æ— æ³•é™åˆ¶ç”¨æˆ·ä¼šè¯æ•°
- âŒ èµ„æºè€—å°½é£é™©
- âŒ åƒµå°¸ä¼šè¯ç´¯ç§¯

**å»ºè®®**ï¼šå¤šç§Ÿæˆ·åœºæ™¯å¿…é¡»ç¦ç”¨æŒä¹…æ¨¡å¼

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **ç¯å¢ƒå˜é‡é…ç½®**: `.env.example`
- **ä¼šè¯ç®¡ç†**: `src/multi-tenant/core/SessionManager.ts`
- **é…ç½®åŠ è½½**: `src/multi-tenant/config/MultiTenantConfig.ts`
- **ç±»å‹å®šä¹‰**: `src/multi-tenant/types/session.types.ts`

---

## ğŸ’¡ æ€»ç»“

æŒä¹…è¿æ¥æ¨¡å¼é€šè¿‡ä»¥ä¸‹æœºåˆ¶è§£å†³å•å®¢æˆ·ç«¯åœºæ™¯ä¸‹çš„è‡ªåŠ¨æ–­è¿é—®é¢˜ï¼š

1. âœ… **æ™ºèƒ½é»˜è®¤**ï¼šæœªè®¾ç½® `MAX_SESSIONS` è‡ªåŠ¨å¯ç”¨
2. âœ… **è·³è¿‡æ¸…ç†**ï¼šæŒä¹…ä¼šè¯ä¸ä¼šè¢«è¶…æ—¶æ¸…ç†
3. âœ… **æ— ç¼ä½“éªŒ**ï¼šIDEé•¿æ—¶é—´ä¸æ“ä½œä¹Ÿèƒ½æ­£å¸¸ä½¿ç”¨
4. âœ… **çµæ´»é…ç½®**ï¼šæ”¯æŒç¯å¢ƒå˜é‡æ˜¾å¼æ§åˆ¶

**æ¨èé…ç½®**ï¼š

- å¼€å‘ç¯å¢ƒï¼šä¾èµ–é»˜è®¤è¡Œä¸ºï¼ˆä¸è®¾ç½® `MAX_SESSIONS`ï¼‰
- ç”Ÿäº§ç¯å¢ƒï¼ˆå•ç”¨æˆ·ï¼‰ï¼šæ˜¾å¼è®¾ç½® `PERSISTENT_MODE=true`
- ç”Ÿäº§ç¯å¢ƒï¼ˆå¤šç§Ÿæˆ·ï¼‰ï¼šè®¾ç½® `MAX_SESSIONS` å¹¶æ˜¾å¼ `PERSISTENT_MODE=false`
