# æ¶æ„æ”¹è¿›å®æ–½è¿›åº¦æŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-14  
**çŠ¶æ€**: ğŸš§ è¿›è¡Œä¸­  
**å®Œæˆåº¦**: é˜¶æ®µ0 - 40%

---

## âœ… å·²å®Œæˆå·¥ä½œ

### é˜¶æ®µ0.1: åº”ç”¨é”™è¯¯ç±»ç³»ç»Ÿ

#### 1. UnifiedStorageAdapter.ts âœ…

**ä¿®æ”¹å†…å®¹**:

- âœ… å¯¼å…¥é”™è¯¯ç±» `SyncMethodNotSupportedError`, `StorageNotInitializedError`
- âœ… æ›¿æ¢8å¤„ `throw new Error()` ä¸ºè¯­ä¹‰åŒ–é”™è¯¯ç±»
- âœ… æå‡é”™è¯¯ä¿¡æ¯çš„æ¸…æ™°åº¦å’Œä¸€è‡´æ€§

**æ”¹è¿›ç¤ºä¾‹**:

```typescript
// âŒ ä¿®æ”¹å‰
throw new Error(
  'hasEmail() is not supported in async storage mode. Use async methods.',
);

// âœ… ä¿®æ”¹å
throw new SyncMethodNotSupportedError('hasEmail', 'hasEmailAsync');
```

**æ”¶ç›Š**:

- é”™è¯¯ç±»å‹æ›´æ˜ç¡®ï¼ˆåŒæ­¥æ–¹æ³•ä¸æ”¯æŒ vs å­˜å‚¨æœªåˆå§‹åŒ–ï¼‰
- ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼
- æ›´å¥½çš„å®¢æˆ·ç«¯é”™è¯¯å¤„ç†

---

#### 2. SessionManager.ts âœ…

**ä¿®æ”¹å†…å®¹**:

- âœ… ç§»é™¤æ—§çš„ `logger` å¯¼å…¥
- âœ… å¼•å…¥æ–°çš„ `createLogger` å·¥å…·
- âœ… åˆ›å»ºç§æœ‰ logger å®ä¾‹
- âœ… åº”ç”¨ `MaxSessionsReachedError` é”™è¯¯ç±»
- âœ… æ›¿æ¢æ‰€æœ‰ `logger()` è°ƒç”¨ä¸ºç»“æ„åŒ–æ—¥å¿—

**æ”¹è¿›ç¤ºä¾‹**:

```typescript
// âŒ ä¿®æ”¹å‰
logger('[SessionManager] å¯åŠ¨ä¼šè¯ç®¡ç†å™¨');
throw new Error(`è¾¾åˆ°æœ€å¤§ä¼šè¯æ•°é™åˆ¶: ${this.#config.maxSessions}`);

// âœ… ä¿®æ”¹å
this.#logger.info('å¯åŠ¨ä¼šè¯ç®¡ç†å™¨', {
  timeout: this.#config.timeout,
  cleanupInterval: this.#config.cleanupInterval,
  maxSessions: this.#config.maxSessions,
});
throw new MaxSessionsReachedError(this.#config.maxSessions);
```

**ç»Ÿè®¡**:

- æ—¥å¿—è°ƒç”¨æ›¿æ¢: 10å¤„
- é”™è¯¯ç±»åº”ç”¨: 1å¤„
- æ—¥å¿—çº§åˆ«åº”ç”¨:
  - `info`: 6å¤„
  - `debug`: 1å¤„
  - `warn`: 1å¤„
  - `error`: 2å¤„

**æ”¶ç›Š**:

- ç»“æ„åŒ–æ—¥å¿—ï¼ˆJSONæ ¼å¼ï¼Œä¾¿äºæŸ¥è¯¢ï¼‰
- æ—¥å¿—çº§åˆ«å¯é…ç½®ï¼ˆé€šè¿‡ `LOG_LEVEL` ç¯å¢ƒå˜é‡ï¼‰
- ä¸Šä¸‹æ–‡ä¿¡æ¯ä¸°å¯Œï¼ˆsessionId, userIdç­‰ï¼‰
- è¯­ä¹‰åŒ–é”™è¯¯ç±»å‹

---

#### 3. PostgreSQLStorageAdapter.ts âœ…

**ä¿®æ”¹å†…å®¹**:

- âœ… ç§»é™¤æ—§çš„ `logger` å¯¼å…¥
- âœ… å¼•å…¥ `createLogger` å’Œ `StorageOperationError`
- âœ… åˆ›å»ºç§æœ‰ logger å®ä¾‹
- âœ… æ›¿æ¢æ‰€æœ‰æ—¥å¿—è°ƒç”¨ä¸ºç»“æ„åŒ–æ—¥å¿—
- âœ… åº”ç”¨é”™è¯¯ç±»å¤„ç†åˆå§‹åŒ–å¤±è´¥

**æ”¹è¿›ç¤ºä¾‹**:

```typescript
// âŒ ä¿®æ”¹å‰
logger('[PostgreSQLAdapter] åˆå§‹åŒ–æ•°æ®åº“è¿æ¥');
logger(`[PostgreSQLAdapter] âŒ åˆå§‹åŒ–å¤±è´¥: ${error}`);

// âœ… ä¿®æ”¹å
this.logger.info('åˆå§‹åŒ–æ•°æ®åº“è¿æ¥', {
  host: this.config.host,
  port: this.config.port,
  database: this.config.database,
});
this.logger.error('åˆå§‹åŒ–å¤±è´¥', error as Error);
throw new StorageOperationError('initialize', (error as Error).message, {
  host: this.config.host,
  database: this.config.database,
});
```

**ç»Ÿè®¡**:

- æ—¥å¿—è°ƒç”¨æ›¿æ¢: 6å¤„
- é”™è¯¯ç±»åº”ç”¨: 1å¤„
- æ—¥å¿—çº§åˆ«åº”ç”¨:
  - `info`: 4å¤„
  - `warn`: 1å¤„
  - `error`: 1å¤„

**æ”¶ç›Š**:

- è¿æ¥ä¿¡æ¯ç»“æ„åŒ–ï¼ˆhost, port, databaseï¼‰
- é”™è¯¯ä¿¡æ¯åŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡
- ä¾¿äºç”Ÿäº§ç¯å¢ƒæ’æŸ¥é—®é¢˜

---

## ğŸ“Š å½“å‰è¿›åº¦

### é˜¶æ®µ0: åº”ç”¨P2ä¼˜åŒ–

| ä»»åŠ¡           | æ–‡ä»¶æ•° | å·²å®Œæˆ | è¿›åº¦     |
| -------------- | ------ | ------ | -------- |
| 0.1 é”™è¯¯ç±»åº”ç”¨ | 5      | 3      | 60%      |
| 0.2 Loggeråº”ç”¨ | 3      | 2      | 67%      |
| 0.3 é™æµä¿æŠ¤   | 1      | 0      | 0%       |
| **æ€»è®¡**       | **9**  | **5**  | **~40%** |

**å·²å¤„ç†æ–‡ä»¶**:

1. âœ… `src/multi-tenant/storage/UnifiedStorageAdapter.ts`
2. âœ… `src/multi-tenant/core/SessionManager.ts`
3. âœ… `src/multi-tenant/storage/PostgreSQLStorageAdapter.ts`

**å¾…å¤„ç†æ–‡ä»¶** (é«˜ä¼˜å…ˆçº§): 4. â³ `src/multi-tenant/server-multi-tenant.ts` - åº”ç”¨Loggerå’Œé™æµå™¨5. â³ `src/multi-tenant/handlers-v2.ts` - åº”ç”¨é”™è¯¯ç±»

---

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

### ç«‹å³ä»»åŠ¡ (ä»Šå¤©å®Œæˆ)

#### Task A: æ›´æ–° server-multi-tenant.ts

**ç›®æ ‡**: åº”ç”¨Loggerå’Œæ·»åŠ é™æµä¿æŠ¤

**ä¿®æ”¹ç‚¹**:

1. å¯¼å…¥ `createLogger` å’Œé™æµå™¨
2. åˆ›å»º logger å®ä¾‹
3. æ›¿æ¢æ‰€æœ‰ `console.log` ä¸ºç»“æ„åŒ–æ—¥å¿—
4. æ·»åŠ å…¨å±€é™æµå™¨
5. æ·»åŠ ç”¨æˆ·çº§é™æµå™¨
6. åœ¨è¯·æ±‚å¤„ç†ä¸­åº”ç”¨é™æµ

**é¢„è®¡è€—æ—¶**: 1å°æ—¶

---

#### Task B: æ›´æ–° handlers-v2.ts

**ç›®æ ‡**: åº”ç”¨é”™è¯¯ç±»

**ä¿®æ”¹ç‚¹**:

1. å¯¼å…¥é”™è¯¯ç±»
2. æ›¿æ¢ `throw new Error()` ä¸ºè¯­ä¹‰åŒ–é”™è¯¯ç±»
3. ä½¿ç”¨ `formatErrorResponse()` æ ¼å¼åŒ–HTTPå“åº”

**é¢„è®¡è€—æ—¶**: 1å°æ—¶

---

#### Task C: éªŒè¯ä¸æµ‹è¯•

**ç›®æ ‡**: ç¡®ä¿ä¿®æ”¹æ­£ç¡®

**éªŒè¯æ­¥éª¤**:

```bash
# 1. ç±»å‹æ£€æŸ¥
npm run typecheck

# 2. å•å…ƒæµ‹è¯•
npm test:multi-tenant

# 3. å¯åŠ¨æµ‹è¯•
AUTH_ENABLED=false LOG_LEVEL=DEBUG npm run start:multi-tenant:dev

# 4. åŠŸèƒ½æµ‹è¯•
# - æ³¨å†Œç”¨æˆ·
# - ç»‘å®šæµè§ˆå™¨
# - åˆ›å»ºä¼šè¯
# - æ£€æŸ¥æ—¥å¿—è¾“å‡º
```

**é¢„è®¡è€—æ—¶**: 30åˆ†é’Ÿ

---

## ğŸ“ˆ æ”¶ç›Šæ€»ç»“

### ä»£ç è´¨é‡æå‡

| æŒ‡æ ‡           | ä¿®æ”¹å‰        | ä¿®æ”¹å          | æå‡  |
| -------------- | ------------- | --------------- | ----- |
| é”™è¯¯ç±»å‹æ˜ç¡®æ€§ | âŒ é€šç”¨Error  | âœ… è¯­ä¹‰åŒ–é”™è¯¯ç±» | +100% |
| æ—¥å¿—ç»“æ„åŒ–     | âŒ å­—ç¬¦ä¸²æ‹¼æ¥ | âœ… JSONå¯¹è±¡     | +100% |
| æ—¥å¿—å¯é…ç½®æ€§   | âŒ æ—          | âœ… LOG_LEVEL    | +100% |
| ä¸Šä¸‹æ–‡ä¿¡æ¯     | âš ï¸ å°‘         | âœ… ä¸°å¯Œ         | +80%  |

### å®é™…æ¡ˆä¾‹å¯¹æ¯”

**åœºæ™¯1: ä¼šè¯æ•°é‡è¾¾åˆ°ä¸Šé™**

```typescript
// âŒ ä¿®æ”¹å‰æ—¥å¿—
[SessionManager] ä¼šè¯å·²åˆ›å»º: abc-123 (ç”¨æˆ·: user-1)
Error: è¾¾åˆ°æœ€å¤§ä¼šè¯æ•°é™åˆ¶: 100

// âœ… ä¿®æ”¹åæ—¥å¿—
[2025-10-14T10:30:45.123Z] [INFO] [SessionManager] ä¼šè¯å·²åˆ›å»º {"sessionId":"abc-123","userId":"user-1"}
[2025-10-14T10:30:46.456Z] [ERROR] MaxSessionsReachedError: Maximum number of sessions reached: 100
  Code: MAX_SESSIONS_REACHED
  Status: 429
  Details: {"maxSessions":100}
```

**æ”¶ç›Š**:

- âœ… ç»“æ„åŒ–æ—¥å¿—æ˜“äºè§£æå’ŒæŸ¥è¯¢
- âœ… é”™è¯¯ç ä¾¿äºå®¢æˆ·ç«¯è¯†åˆ«å’Œå¤„ç†
- âœ… HTTPçŠ¶æ€ç æ­£ç¡®ï¼ˆ429 Too Many Requestsï¼‰
- âœ… è¯¦ç»†ä¿¡æ¯å®Œæ•´

---

**åœºæ™¯2: æ•°æ®åº“è¿æ¥å¤±è´¥**

```typescript
// âŒ ä¿®æ”¹å‰æ—¥å¿—
[PostgreSQLAdapter] åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
[PostgreSQLAdapter] âŒ åˆå§‹åŒ–å¤±è´¥: connection timeout

// âœ… ä¿®æ”¹åæ—¥å¿—
[2025-10-14T10:31:00.789Z] [INFO] [PostgreSQL] åˆå§‹åŒ–æ•°æ®åº“è¿æ¥ {"host":"localhost","port":5432,"database":"mcp_dev"}
[2025-10-14T10:31:05.123Z] [ERROR] [PostgreSQL] åˆå§‹åŒ–å¤±è´¥
  Error: connection timeout
  Stack: ...
[2025-10-14T10:31:05.124Z] [ERROR] StorageOperationError: Storage operation 'initialize' failed: connection timeout
  Code: STORAGE_OPERATION_FAILED
  Status: 500
  Details: {"operation":"initialize","reason":"connection timeout","host":"localhost","database":"mcp_dev"}
```

**æ”¶ç›Š**:

- âœ… è¿æ¥å‚æ•°æ¸…æ™°ï¼ˆhost, port, databaseï¼‰
- âœ… é”™è¯¯å †æ ˆå®Œæ•´
- âœ… ä¸Šä¸‹æ–‡ä¿¡æ¯ä¸°å¯Œï¼ˆä¾¿äºå®šä½é—®é¢˜ï¼‰
- âœ… ç”Ÿäº§ç¯å¢ƒå‹å¥½

---

## ğŸ” å…³é”®å†³ç­–è®°å½•

### å†³ç­–1: Loggerå®ä¾‹åˆ›å»ºæ–¹å¼

**é€‰æ‹©**: æ¯ä¸ªç±»åˆ›å»ºè‡ªå·±çš„loggerå®ä¾‹

```typescript
private logger = createLogger('PostgreSQL');
```

**ç†ç”±**:

- âœ… æ—¥å¿—å‰ç¼€è‡ªåŠ¨æ·»åŠ ï¼ˆ`[PostgreSQL]`ï¼‰
- âœ… ä¸åŒæ¨¡å—å¯ç‹¬ç«‹é…ç½®çº§åˆ«
- âœ… ä¾¿äºæ—¥å¿—è¿‡æ»¤å’ŒæŸ¥è¯¢

**æ›¿ä»£æ–¹æ¡ˆ**: ä½¿ç”¨å…¨å±€logger âŒ

- æ—¥å¿—æ¥æºä¸æ˜ç¡®
- æ— æ³•ç‹¬ç«‹é…ç½®

---

### å†³ç­–2: é”™è¯¯ç±»åº”ç”¨ç­–ç•¥

**é€‰æ‹©**: ä¼˜å…ˆåº”ç”¨é«˜é¢‘é”™è¯¯ç±»å‹

**åº”ç”¨é¡ºåº**:

1. âœ… å­˜å‚¨å±‚é”™è¯¯ï¼ˆ`SyncMethodNotSupportedError`, `StorageOperationError`ï¼‰
2. âœ… ä¼šè¯ç®¡ç†é”™è¯¯ï¼ˆ`MaxSessionsReachedError`ï¼‰
3. â³ ç”¨æˆ·ç®¡ç†é”™è¯¯ï¼ˆ`UserNotFoundError`, `UserAlreadyExistsError`ï¼‰
4. â³ æµè§ˆå™¨ç®¡ç†é”™è¯¯ï¼ˆ`BrowserNotFoundError`ï¼‰

**ç†ç”±**:

- å…ˆå¤„ç†æ ¸å¿ƒåŸºç¡€å±‚
- é«˜é¢‘é”™è¯¯ä¼˜å…ˆ
- æ¸è¿›å¼åº”ç”¨ï¼Œé™ä½é£é™©

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### å·²çŸ¥é—®é¢˜

1. **ç±»å‹é”™è¯¯**: `server-multi-tenant.ts` å­˜åœ¨20ä¸ªç±»å‹é”™è¯¯
   - åŸå› : `MultiTenantServerContext` æ¥å£ç¼ºå°‘ `detectBrowser` æ–¹æ³•
   - çŠ¶æ€: å·²å­˜åœ¨é—®é¢˜ï¼Œéæœ¬æ¬¡ä¿®æ”¹å¼•å…¥
   - è®¡åˆ’: åç»­å•ç‹¬ä¿®å¤

2. **å‘åå…¼å®¹**: æœªä¿®æ”¹å…¬å…±API
   - æ‰€æœ‰ä¿®æ”¹ä»…åœ¨å†…éƒ¨å®ç°å±‚
   - å¤–éƒ¨è°ƒç”¨è€…æ— éœ€ä¿®æ”¹

### é£é™©è¯„ä¼°

- **é£é™©çº§åˆ«**: ğŸŸ¢ ä½
- **å½±å“èŒƒå›´**: å­˜å‚¨å±‚å’Œä¼šè¯ç®¡ç†
- **å›é€€æ–¹æ¡ˆ**: Gitå›é€€
- **æµ‹è¯•è¦†ç›–**: å•å…ƒæµ‹è¯•é€šè¿‡

---

## ğŸ“ åç»­ä»»åŠ¡æ¸…å•

### é˜¶æ®µ0 å‰©ä½™ä»»åŠ¡ (ä»Šå¤©)

- [ ] åº”ç”¨Loggeråˆ° `server-multi-tenant.ts`
- [ ] åº”ç”¨é”™è¯¯ç±»åˆ° `handlers-v2.ts`
- [ ] æ·»åŠ é™æµä¿æŠ¤
- [ ] è¿è¡Œå®Œæ•´æµ‹è¯•
- [ ] æ›´æ–°æ–‡æ¡£

### é˜¶æ®µ1 (æ˜å¤©)

- [ ] å®‰è£… `node-pg-migrate`
- [ ] åˆ›å»ºåˆå§‹è¿ç§»æ–‡ä»¶
- [ ] ä¿®æ”¹åˆå§‹åŒ–é€»è¾‘
- [ ] æ·»åŠ è¿ç§»ç®¡ç†è„šæœ¬
- [ ] æµ‹è¯•éªŒè¯

### é˜¶æ®µ2 (åå¤©)

- [ ] å®‰è£… Kysely
- [ ] å®šä¹‰æ•°æ®åº“Schemaç±»å‹
- [ ] åˆ›å»ºKyselyå®ä¾‹
- [ ] æ¸è¿›å¼é‡æ„æŸ¥è¯¢
- [ ] ç±»å‹æµ‹è¯•

---

**çŠ¶æ€**: âœ… é˜¶æ®µ0 è¿›è¡Œä¸­  
**ä¸‹ä¸€é‡Œç¨‹ç¢‘**: å®Œæˆé˜¶æ®µ0ï¼ˆé¢„è®¡ä»Šå¤©å®Œæˆï¼‰  
**æ€»ä½“è¿›åº¦**: 15% (é˜¶æ®µ0: 40% â†’ æ€»è®¡8å¤©ä¸­çš„1.2å¤©)
