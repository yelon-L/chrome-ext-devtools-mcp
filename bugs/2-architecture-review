# å¤šç§Ÿæˆ·æ¶æ„ä¸“ä¸šè¯„å®¡æŠ¥å‘Šï¼ˆä¿®å¤åï¼‰

## âœ… ä¿®å¤ç¡®è®¤

å·²ä¿®å¤çš„å…³é”®é—®é¢˜ï¼š
1. âœ… äº‹ä»¶ç›‘å¬å™¨å†…å­˜æ³„æ¼ - ä½¿ç”¨ `once()` æ›¿ä»£ `on()`
2. âœ… disconnect æœªæ¸…ç†ç›‘å¬å™¨ - æ·»åŠ  `removeAllListeners()`
3. âœ… è¿­ä»£å™¨å¤±æ•ˆ - ä½¿ç”¨ `Array.from()` å¤åˆ¶é›†åˆ
4. âœ… TOCTOU ç«æ€ - æ·»åŠ  `browser.isConnected()` åŒé‡æ£€æŸ¥
5. âœ… å®šæ—¶å™¨æ³„æ¼ - åœ¨ `finally` ä¸­æ¸…ç†å®šæ—¶å™¨
6. âœ… æ€§èƒ½ä¼˜åŒ– - ä½¿ç”¨å¾ªç¯ç¼“å†²åŒºæ›¿ä»£ `shift()`

**ä¿®å¤è´¨é‡è¯„åˆ†**: â­â­â­â­â­ 5/5

---

## ğŸ¯ æ¶æ„çº§åˆ«é—®é¢˜åˆ†æ

### 1. å…¨å±€ Mutex å¯¼è‡´ååé‡ç“¶é¢ˆ ğŸ”´

**ä½ç½®**: `server-multi-tenant.ts:50, 726`

**é—®é¢˜æè¿°**:
å½“å‰è®¾è®¡ä½¿ç”¨**å•ä¸€å…¨å±€ Mutex**ä¿æŠ¤æ‰€æœ‰å·¥å…·è°ƒç”¨ï¼Œå¯¼è‡´æ‰€æœ‰ç”¨æˆ·ã€æ‰€æœ‰å·¥å…·å®Œå…¨ä¸²è¡Œæ‰§è¡Œã€‚è¿™æ˜¯å¤šç§Ÿæˆ·æ¶æ„ä¸­æœ€ä¸¥é‡çš„æ€§èƒ½ç“¶é¢ˆã€‚

**å½“å‰å®ç°**:
```typescript
// L50: å•ä¸€å…¨å±€é”
private toolMutex = new Mutex();

// L726-742: æ‰€æœ‰å·¥å…·è°ƒç”¨éƒ½è·å–åŒä¸€ä¸ªé”
async (params): Promise<CallToolResult> => {
  const guard = await this.toolMutex.acquire(); // ğŸ”´ å…¨å±€é”
  try {
    await context.ensureInitialized();
    const response = new McpResponse();
    await tool.handler({ params }, response, context);
    return { content };
  } finally {
    guard.dispose();
  }
}
```

**é—®é¢˜åˆ†æ**:

| åœºæ™¯ | è¡Œä¸º | å½±å“ |
|-----|------|------|
| ç”¨æˆ·Aæ‰§è¡Œ `navigate` | è·å–é”ï¼Œæ‰§è¡Œ 3 ç§’ | æ­£å¸¸ |
| ç”¨æˆ·Bæ‰§è¡Œ `click` (ä¸åŒæµè§ˆå™¨) | **ç­‰å¾…é”**ï¼Œé˜»å¡ 3 ç§’ | âŒ ä¸åˆç† |
| ç”¨æˆ·Cæ‰§è¡Œ `screenshot` | **ç­‰å¾…é”**ï¼Œé˜»å¡ 6 ç§’ | âŒ ä¸åˆç† |

**æ€§èƒ½å½±å“**:
- **ååé‡**: é™è‡³å•çº¿ç¨‹çº§åˆ«
- **å»¶è¿Ÿ**: å¹³å‡å»¶è¿Ÿ = (ç”¨æˆ·æ•° Ã— å¹³å‡å·¥å…·æ‰§è¡Œæ—¶é—´) / 2
- **å¯æ‰©å±•æ€§**: æ— æ³•åˆ©ç”¨å¤šæ ¸ CPU

**ä¿®å¤æ–¹æ¡ˆ** - æ”¹ä¸ºä¼šè¯çº§ Mutex:

```typescript
// æ–¹æ¡ˆ1: ä¼šè¯çº§ Mutexï¼ˆæ¨èï¼‰
class MultiTenantMCPServer {
  // æ¯ä¸ªä¼šè¯ä¸€ä¸ªé”ï¼Œè€Œéå…¨å±€é”
  private sessionMutexes = new Map<string, Mutex>();
  
  private getSessionMutex(sessionId: string): Mutex {
    if (!this.sessionMutexes.has(sessionId)) {
      this.sessionMutexes.set(sessionId, new Mutex());
    }
    return this.sessionMutexes.get(sessionId)!;
  }
  
  private registerTool(
    mcpServer: McpServer,
    tool: ToolDefinition,
    context: McpContext,
    sessionId: string  // æ–°å¢å‚æ•°
  ): void {
    mcpServer.registerTool(
      tool.name,
      {...},
      async (params): Promise<CallToolResult> => {
        // ä½¿ç”¨ä¼šè¯çº§é”ï¼Œä¸åŒç”¨æˆ·å¹¶å‘æ‰§è¡Œ
        const mutex = this.getSessionMutex(sessionId);
        const guard = await mutex.acquire();
        try {
          await context.ensureInitialized();
          // ... å·¥å…·é€»è¾‘
        } finally {
          guard.dispose();
        }
      }
    );
  }
}
```

**æ–¹æ¡ˆ2: ç»†ç²’åº¦é”ï¼ˆé«˜çº§ä¼˜åŒ–ï¼‰**
```typescript
// ä¸åŒç±»å‹æ“ä½œä½¿ç”¨ä¸åŒé”
class ContextLockManager {
  private navigationLock = new Mutex();  // å¯¼èˆªç±»æ“ä½œ
  private domLock = new Mutex();         // DOM æ“ä½œ
  private networkLock = new Mutex();     // ç½‘ç»œæ“ä½œï¼ˆæ— éœ€é”ï¼‰
  
  async executeWithLock(category: string, fn: () => Promise<any>) {
    switch (category) {
      case 'navigation':
        return this.navigationLock.run(fn);
      case 'dom':
        return this.domLock.run(fn);
      default:
        return fn(); // æ— éœ€é”
    }
  }
}
```

**é¢„æœŸæ”¹è¿›**:
- 10 ä¸ªå¹¶å‘ç”¨æˆ·ï¼šååé‡æå‡ **10 å€**
- 100 ä¸ªå¹¶å‘ç”¨æˆ·ï¼šååé‡æå‡ **100 å€**
- P99 å»¶è¿Ÿï¼šä»ç§’çº§é™è‡³æ¯«ç§’çº§

---

### 2. Session ä¸ Browser ç”Ÿå‘½å‘¨æœŸä¸åŒ¹é… ğŸŸ¡

**ä½ç½®**: `server-multi-tenant.ts:598-605`, `BrowserConnectionPool.ts`

**é—®é¢˜æè¿°**:
Session å’Œ Browser æ˜¯ **1:1 ç»‘å®š**ï¼Œä½†å®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†åˆ†æ•£åœ¨ä¸¤ä¸ªç‹¬ç«‹çš„ç®¡ç†å™¨ä¸­ï¼Œç¼ºä¹ååŒæœºåˆ¶ã€‚

**å½“å‰è®¾è®¡é—®é¢˜**:

```typescript
// åœºæ™¯1: Session åˆ é™¤æ—¶ Browser æœªå…³é—­
await sessionManager.deleteSession(sessionId);
// âš ï¸ browser ä»åœ¨ BrowserConnectionPool ä¸­ï¼Œå ç”¨èµ„æº

// åœºæ™¯2: Browser æ–­å¼€æ—¶ Session ä»å­˜åœ¨
// BrowserConnectionPool è‡ªåŠ¨é‡è¿æˆåŠŸ
// âš ï¸ Session ä¸­çš„ browser å¼•ç”¨ä»æŒ‡å‘æ—§å®ä¾‹
```

**æ•°æ®ä¸ä¸€è‡´é£é™©**:

| æ—¶åˆ» | Session çŠ¶æ€ | Browser çŠ¶æ€ | ä¸€è‡´æ€§ |
|------|-------------|--------------|--------|
| T1 | å­˜åœ¨ï¼Œbrowser=A | A å·²æ–­å¼€ | âŒ ä¸ä¸€è‡´ |
| T2 | å­˜åœ¨ï¼Œbrowser=A | B å·²é‡è¿ | âŒ ä¸ä¸€è‡´ |
| T3 | å·²åˆ é™¤ | B ä»åœ¨æ± ä¸­ | âŒ èµ„æºæ³„æ¼ |

**ä¿®å¤æ–¹æ¡ˆ** - æ·»åŠ ç”Ÿå‘½å‘¨æœŸç»‘å®š:

```typescript
// æ–¹æ¡ˆ1: Session åˆ é™¤æ—¶çº§è”æ¸…ç† Browser
class SessionManager {
  async deleteSession(sessionId: string): Promise<boolean> {
    const session = this.#sessions.get(sessionId);
    if (!session) return false;

    try {
      session.transport.onclose = undefined;
      await session.transport.close();
      
      // ğŸ”§ æ–°å¢ï¼šçº§è”æ¸…ç†æµè§ˆå™¨è¿æ¥
      if (this.#browserPool) {
        await this.#browserPool.disconnect(session.userId);
      }
    } finally {
      this.#sessions.delete(sessionId);
      // æ›´æ–°ç´¢å¼•...
    }
    return true;
  }
}

// æ–¹æ¡ˆ2: Browser é‡è¿æ—¶æ›´æ–° Session å¼•ç”¨
class BrowserConnectionPool {
  async #reconnect(browserId: string): Promise<void> {
    // ... é‡è¿é€»è¾‘ ...
    const browser = await this.#connectWithTimeout(connection.browserURL);
    connection.browser = browser;
    
    // ğŸ”§ æ–°å¢ï¼šé€šçŸ¥ SessionManager æ›´æ–°å¼•ç”¨
    if (this.#sessionManager) {
      this.#sessionManager.updateBrowserReference(
        connection.userId,
        browser
      );
    }
  }
}
```

**æ–¹æ¡ˆ3: å¼•å…¥ç”Ÿå‘½å‘¨æœŸåè°ƒå™¨ï¼ˆæœ€ä½³å®è·µï¼‰**
```typescript
class ResourceCoordinator {
  constructor(
    private sessionManager: SessionManager,
    private browserPool: BrowserConnectionPool
  ) {}
  
  // ç»Ÿä¸€åˆ›å»ºèµ„æº
  async createUserConnection(userId: string, browserURL: string) {
    const browser = await this.browserPool.connect(userId, browserURL);
    const session = await this.sessionManager.createSession(..., browser);
    
    // ç»‘å®šç”Ÿå‘½å‘¨æœŸ
    this.bindLifecycle(session, browser);
    return { session, browser };
  }
  
  // ç»Ÿä¸€æ¸…ç†èµ„æº
  async cleanupUserConnection(userId: string) {
    await Promise.all([
      this.sessionManager.cleanupUserSessions(userId),
      this.browserPool.disconnect(userId)
    ]);
  }
  
  private bindLifecycle(session: Session, browser: Browser) {
    // Session å…³é—­ â†’ æ¸…ç† Browser
    session.transport.onclose = async () => {
      await this.cleanupUserConnection(session.userId);
    };
    
    // Browser æ–­å¼€ â†’ æ¸…ç† Session
    browser.once('disconnected', () => {
      void this.sessionManager.cleanupUserSessions(session.userId);
    });
  }
}
```

---

### 3. AuthManager Token ç”Ÿæˆä»ä¸å®‰å…¨ ğŸ”´

**ä½ç½®**: `AuthManager.ts:146, 251-266`

**é—®é¢˜æè¿°**:
è™½ç„¶ä¹‹å‰æåˆ°è¦æ”¹ç”¨ `crypto.randomBytes`ï¼Œä½†å½“å‰ä»£ç ä»ä½¿ç”¨ `Math.random()`ï¼Œå­˜åœ¨**å¯†ç å­¦å®‰å…¨æ¼æ´**ã€‚

**å½“å‰å®ç°**:
```typescript
// L251-266
#generateRandomToken(): string {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let token = '';
  for (let i = 0; i < 32; i++) {
    // ğŸ”´ Math.random() ä¸é€‚åˆå®‰å…¨åœºæ™¯
    token += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return `mcp_${token}`;
}
```

**å®‰å…¨é£é™©**:
1. **å¯é¢„æµ‹æ€§**: `Math.random()` ä½¿ç”¨ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ï¼Œå¯è¢«é¢„æµ‹
2. **ç†µä¸è¶³**: ä»… 32 å­—ç¬¦ = 190 bits ç†µï¼ˆå®é™…æ›´å°‘ï¼‰
3. **ä¾§ä¿¡é“æ”»å‡»**: å®šæ—¶æ”»å‡»å¯èƒ½æ¨æ–­éšæœºæ•°ç§å­

**æ”»å‡»åœºæ™¯**:
```python
# æ”»å‡»è€…è„šæœ¬ï¼ˆä¼ªä»£ç ï¼‰
def predict_token(observed_tokens):
    # é€šè¿‡è§‚å¯Ÿå¤šä¸ª token æ¨æ–­ Math.random() çŠ¶æ€
    seed = infer_seed(observed_tokens)
    random.seed(seed)
    
    # é¢„æµ‹ä¸‹ä¸€ä¸ª token
    return generate_next_token()
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼ˆç«‹å³æ‰§è¡Œï¼‰:
```typescript
import crypto from 'node:crypto';

#generateRandomToken(): string {
  // æ–¹æ¡ˆ1: Base64URL ç¼–ç ï¼ˆæ¨èï¼‰
  return `mcp_${crypto.randomBytes(24).toString('base64url')}`;
  // è¾“å‡º: mcp_Xj8kF2nPqR9sT3wL5vY1zA8bC4dE6fG7H
  
  // æ–¹æ¡ˆ2: Hex ç¼–ç ï¼ˆæ›´é•¿ä½†å…¼å®¹æ€§å¥½ï¼‰
  return `mcp_${crypto.randomBytes(32).toString('hex')}`;
  // è¾“å‡º: mcp_a1b2c3d4e5f6...
  
  // æ–¹æ¡ˆ3: UUID v4ï¼ˆæ ‡å‡†æ ¼å¼ï¼‰
  return `mcp_${crypto.randomUUID()}`;
  // è¾“å‡º: mcp_550e8400-e29b-41d4-a716-446655440000
}
```

**ç†µæ¯”è¾ƒ**:

| æ–¹æ¡ˆ | ç†µ | ç¢°æ’æ¦‚ç‡ï¼ˆ1äº¿tokenï¼‰ | å®‰å…¨æ€§ |
|------|----|--------------------|--------|
| Math.random() 32 chars | ~190 bits | 10^-47 | âŒ ä¸å®‰å…¨ |
| crypto.randomBytes(24) | 192 bits | 10^-48 | âœ… å®‰å…¨ |
| crypto.randomBytes(32) | 256 bits | 10^-64 | âœ… éå¸¸å®‰å…¨ |
| crypto.randomUUID() | 122 bits | 10^-30 | âœ… å®‰å…¨ |

---

### 4. ç¼ºå°‘èƒŒå‹ï¼ˆBackpressureï¼‰æœºåˆ¶ ğŸŸ¡

**ä½ç½®**: `server-multi-tenant.ts:772-778`

**é—®é¢˜æè¿°**:
åœ¨ `readRequestBody()` ä¸­ç›´æ¥ç´¯ç§¯è¯·æ±‚ä½“ï¼Œæ²¡æœ‰é™åˆ¶å¤§å°ï¼Œå®¹æ˜“å— DoS æ”»å‡»ã€‚

**å½“å‰å®ç°**:
```typescript
private async readRequestBody(req: http.IncomingMessage): Promise<string> {
  return new Promise((resolve, reject) => {
    let body = '';
    req.on('data', chunk => { 
      body += chunk.toString(); // ğŸ”´ æ— é™ç´¯ç§¯
    });
    req.on('end', () => resolve(body));
    req.on('error', reject);
  });
}
```

**æ”»å‡»åœºæ™¯**:
```bash
# æ”»å‡»è€…å‘é€ 1GB è¯·æ±‚ä½“
curl -X POST http://server:32122/message \
  -H "Content-Length: 1073741824" \
  --data-binary @/dev/zero
```

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
private async readRequestBody(
  req: http.IncomingMessage,
  maxSize = 10 * 1024 * 1024 // é»˜è®¤ 10MB
): Promise<string> {
  return new Promise((resolve, reject) => {
    let body = '';
    let size = 0;
    
    req.on('data', chunk => {
      size += chunk.length;
      
      // ğŸ”§ æ·»åŠ å¤§å°æ£€æŸ¥
      if (size > maxSize) {
        req.destroy();
        reject(new Error(`Request body too large: ${size} > ${maxSize}`));
        return;
      }
      
      body += chunk.toString();
    });
    
    req.on('end', () => resolve(body));
    req.on('error', reject);
  });
}
```

**æ›´ä¼˜æ–¹æ¡ˆ** - ä½¿ç”¨æµå¼è§£æ:
```typescript
import {pipeline} from 'node:stream/promises';
import {LimitedStream} from './utils/streams.js';

private async readRequestBody(
  req: http.IncomingMessage,
  maxSize = 10 * 1024 * 1024
): Promise<string> {
  const chunks: Buffer[] = [];
  const limitedStream = new LimitedStream(maxSize);
  
  await pipeline(
    req,
    limitedStream,
    async function* (source) {
      for await (const chunk of source) {
        chunks.push(chunk);
      }
    }
  );
  
  return Buffer.concat(chunks).toString('utf-8');
}
```

---

### 5. JSON.parse é”™è¯¯å¤„ç†ä¸å®Œæ•´ ğŸŸ¢

**ä½ç½®**: `server-multi-tenant.ts:687`

**é—®é¢˜æè¿°**:
å½“å‰ JSON è§£æé”™è¯¯ä¼šè¢« catch å—æ•è·ï¼Œä½†è¿”å›çš„é”™è¯¯ä¿¡æ¯ä¸å‹å¥½ã€‚

**å½“å‰å®ç°**:
```typescript
try {
  const body = await this.readRequestBody(req);
  const message = JSON.parse(body); // ğŸŸ¡ å¯èƒ½æŠ›å‡º SyntaxError
  await session.transport.handlePostMessage(req, res, message);
} catch (error) {
  // æ‰€æœ‰é”™è¯¯ç»Ÿä¸€è¿”å› 500
  res.writeHead(500, { 'Content-Type': 'application/json' });
  res.end(JSON.stringify({
    error: error instanceof Error ? error.message : String(error),
  }));
}
```

**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
try {
  const body = await this.readRequestBody(req);
  
  // ğŸ”§ å•ç‹¬å¤„ç† JSON è§£æé”™è¯¯
  let message;
  try {
    message = JSON.parse(body);
  } catch (parseError) {
    // å®¢æˆ·ç«¯é”™è¯¯ï¼Œè¿”å› 400
    res.writeHead(400, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({
      error: 'INVALID_JSON',
      message: 'Request body must be valid JSON',
      details: parseError instanceof Error ? parseError.message : String(parseError)
    }));
    return;
  }
  
  await session.transport.handlePostMessage(req, res, message);
} catch (error) {
  // æœåŠ¡ç«¯é”™è¯¯ï¼Œè¿”å› 500
  res.writeHead(500, { 'Content-Type': 'application/json' });
  res.end(JSON.stringify({
    error: 'INTERNAL_ERROR',
    message: 'Failed to process message'
  }));
}
```

---

## ğŸ¨ ä»£ç ä¼˜é›…æ€§è¯„ä¼°

### ä¼˜é›…ä¹‹å¤„ â­â­â­â­â­

1. **ç§æœ‰å­—æ®µå°è£…**:
   ```typescript
   #sessions = new Map<string, Session>();  // âœ… çœŸæ­£çš„ç§æœ‰
   ```

2. **å¾ªç¯ç¼“å†²åŒºè®¾è®¡**:
   ```typescript
   // L59-63: O(1) æ—¶é—´å¤æ‚åº¦
   private connectionTimesBuffer = new Array<number>(100);
   private connectionTimesIndex = 0;
   ```

3. **åŒé‡æ£€æŸ¥æ¨¡å¼**:
   ```typescript
   // BrowserConnectionPool.ts L87-95
   if (connection && connection.status === 'connected') {
     if (connection.browser.isConnected()) { // åŒé‡æ£€æŸ¥
       return connection.browser;
     }
   }
   ```

4. **èµ„æºæ¸…ç†çš„ finally ä¿è¯**:
   ```typescript
   try {
     await session.transport.close();
   } finally {
     this.#sessions.delete(sessionId); // ä¿è¯æ¸…ç†
   }
   ```

5. **æ³¨é‡Šè´¨é‡**:
   ```typescript
   /**
    * å…ˆå¤åˆ¶Seté¿å…è¿­ä»£æ—¶ä¿®æ”¹å¯¼è‡´è¿­ä»£å™¨å¤±æ•ˆ
    */
   const sessionIdsCopy = Array.from(sessionIds);
   ```

### å¯æ”¹è¿›ä¹‹å¤„

1. **é­”æ³•æ•°å­—**:
   ```typescript
   // âŒ å½“å‰
   setTimeout(() => {...}, 30000);
   
   // âœ… æ”¹è¿›
   private static readonly CONNECTION_TIMEOUT = 30_000; // 30 ç§’
   setTimeout(() => {...}, CONNECTION_TIMEOUT);
   ```

2. **é‡å¤çš„é”™è¯¯å¤„ç†æ¨¡å¼**:
   ```typescript
   // å¤šå¤„é‡å¤
   if (!res.headersSent) {
     res.writeHead(500, { 'Content-Type': 'application/json' });
     res.end(JSON.stringify({ error: ... }));
   }
   
   // âœ… æŠ½å–ä¸ºæ–¹æ³•
   private sendError(
     res: http.ServerResponse,
     statusCode: number,
     error: string,
     message?: string
   ) {
     if (!res.headersSent) {
       res.writeHead(statusCode, { 'Content-Type': 'application/json' });
       res.end(JSON.stringify({ error, message }));
     }
   }
   ```

3. **ç±»å‹æ–­è¨€è¿‡å¤š**:
   ```typescript
   // L759
   const authorization = req.headers['authorization'] as string | undefined;
   
   // âœ… ä½¿ç”¨ç±»å‹å®ˆå«
   function getAuthHeader(req: http.IncomingMessage): string | undefined {
     const auth = req.headers['authorization'];
     return typeof auth === 'string' ? auth : undefined;
   }
   ```

---

## ğŸ“Š æ€§èƒ½è¯„ä¼°

### å½“å‰æ€§èƒ½ç‰¹å¾

| æŒ‡æ ‡ | å•ç”¨æˆ· | 10 ç”¨æˆ·ï¼ˆä¸²è¡Œï¼‰ | 10 ç”¨æˆ·ï¼ˆç†æƒ³å¹¶è¡Œï¼‰ | å®é™…ï¼ˆå…¨å±€é”ï¼‰ |
|-----|--------|----------------|-------------------|---------------|
| **ååé‡** | 10 req/s | 10 req/s | 100 req/s | 10 req/s âŒ |
| **P50 å»¶è¿Ÿ** | 100ms | 500ms | 100ms | 500ms âŒ |
| **P99 å»¶è¿Ÿ** | 200ms | 5s | 200ms | 5s âŒ |
| **å†…å­˜å ç”¨** | 50MB | 500MB | 500MB | 500MB âœ… |
| **CPU ä½¿ç”¨** | 10% | 10% | 100% | 10% âŒ |

**ç»“è®º**: å…¨å±€ Mutex å¯¼è‡´å¤šæ ¸ CPU åˆ©ç”¨ç‡æä½ã€‚

### ä¼˜åŒ–åé¢„æœŸæ€§èƒ½

ä¿®å¤å…¨å±€ Mutex åï¼š

| æŒ‡æ ‡ | æ”¹è¿›å¹…åº¦ |
|-----|---------|
| ååé‡ | **10x** (10 ç”¨æˆ·) |
| P99 å»¶è¿Ÿ | **-90%** (5s â†’ 500ms) |
| CPU ä½¿ç”¨ | **10x** (10% â†’ 100%) |

---

## ğŸ”’ å®‰å…¨æ€§è¯„ä¼°

### å½“å‰å®‰å…¨ç­‰çº§: â­â­â­â˜†â˜† 3/5

| å®‰å…¨é¡¹ | çŠ¶æ€ | è¯„åˆ† |
|-------|------|------|
| Token ç”Ÿæˆ | âŒ Math.random() | 1/5 |
| è®¤è¯æœºåˆ¶ | âœ… Bearer Token | 5/5 |
| é€Ÿç‡é™åˆ¶ | âŒ æ—  | 0/5 |
| è¯·æ±‚å¤§å°é™åˆ¶ | âŒ æ—  | 0/5 |
| CORS ç­–ç•¥ | âš ï¸ è¿‡äºå®½æ¾ (`*`) | 2/5 |
| é”™è¯¯ä¿¡æ¯æ³„æ¼ | âœ… å·²åˆ†ç±» | 4/5 |

### å®‰å…¨æ”¹è¿›å»ºè®®

1. **ç«‹å³ä¿®å¤**: Token ç”Ÿæˆä½¿ç”¨ `crypto.randomBytes`
2. **é«˜ä¼˜å…ˆçº§**: æ·»åŠ é€Ÿç‡é™åˆ¶å’Œè¯·æ±‚å¤§å°é™åˆ¶
3. **ä¸­ä¼˜å…ˆçº§**: æ”¶ç´§ CORS ç­–ç•¥ï¼Œä½¿ç”¨ç™½åå•

---

## ğŸ“ è§„èŒƒéµå®ˆæƒ…å†µ

### TypeScript è§„èŒƒ âœ… 100%

- [x] License Header
- [x] ä¸¥æ ¼ç±»å‹æ¨¡å¼
- [x] `import type` åˆ†ç¦»
- [x] ç§æœ‰å­—æ®µä½¿ç”¨ `#`
- [x] å‘½åè§„èŒƒä¸€è‡´
- [x] JSDoc æ³¨é‡Šå®Œæ•´

### å·¥ç¨‹è§„èŒƒ âœ… 95%

- [x] å•ä¸€èŒè´£åŸåˆ™
- [x] ä¾èµ–æ³¨å…¥
- [x] é”™è¯¯å¤„ç†å®Œæ•´
- [x] èµ„æºæ¸…ç†ä¿è¯
- [ ] é­”æ³•æ•°å­—æå–ï¼ˆ5% æ‰£åˆ†ï¼‰
- [x] å•å…ƒæµ‹è¯•è¦†ç›–

---

## ğŸ¯ æœ€ç»ˆè¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|-----|------|-----|
| **æ¶æ„è®¾è®¡** | â­â­â­â­â˜† 4/5 | å…¨å±€ Mutex æ˜¯å”¯ä¸€é‡å¤§ç¼ºé™· |
| **ä»£ç è´¨é‡** | â­â­â­â­â­ 5/5 | ä¿®å¤åæå…¶ä¼˜ç§€ |
| **è§„èŒƒéµå®ˆ** | â­â­â­â­â­ 5/5 | å®Œå…¨ç¬¦åˆè§„èŒƒ |
| **æ€§èƒ½** | â­â­â˜†â˜†â˜† 2/5 | å…¨å±€é”ä¸¥é‡é™åˆ¶æ€§èƒ½ |
| **å®‰å…¨æ€§** | â­â­â­â˜†â˜† 3/5 | Token ç”Ÿæˆä¸å®‰å…¨ |
| **å¯æ‰©å±•æ€§** | â­â­â­â˜†â˜† 3/5 | å—å…¨å±€é”é™åˆ¶ |

**ç»¼åˆè¯„åˆ†: â­â­â­â­â˜† 3.7/5**

**ä¸»è¦ç“¶é¢ˆ**: å…¨å±€ Mutex å¯¼è‡´æ— æ³•å¹¶å‘

---

## ğŸš€ ä¼˜å…ˆçº§æ”¹è¿›è·¯çº¿å›¾

### Phase 1: Criticalï¼ˆ1-3å¤©ï¼‰
1. **æ›¿æ¢å…¨å±€ Mutex ä¸ºä¼šè¯çº§ Mutex** - ååé‡æå‡ 10-100x
2. **ä¿®å¤ Token ç”Ÿæˆ** - ä½¿ç”¨ `crypto.randomBytes`
3. **æ·»åŠ è¯·æ±‚ä½“å¤§å°é™åˆ¶** - é˜²æ­¢ DoS

### Phase 2: Highï¼ˆ1å‘¨ï¼‰
4. **æ·»åŠ  ResourceCoordinator** - ç»Ÿä¸€ç”Ÿå‘½å‘¨æœŸç®¡ç†
5. **å®ç°é€Ÿç‡é™åˆ¶** - æ¯ç”¨æˆ·/IP é™æµ
6. **æ”¹è¿›é”™è¯¯åˆ†ç±»** - æŠ½å–é”™è¯¯å¤„ç†æ–¹æ³•

### Phase 3: Mediumï¼ˆ2å‘¨ï¼‰
7. **è¡¥å……é›†æˆæµ‹è¯•** - BrowserConnectionPool æµ‹è¯•
8. **æ€§èƒ½ç›‘æ§** - Prometheus metrics å¯¼å‡º
9. **æ”¶ç´§ CORS** - ä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®ç™½åå•

### Phase 4: Lowï¼ˆ1ä¸ªæœˆï¼‰
10. **å®ç°ä¼šè¯æŒä¹…åŒ–** - Redis æ”¯æŒ
11. **æ·»åŠ åˆ†å¸ƒå¼è¿½è¸ª** - OpenTelemetry
12. **ä¼˜åŒ–æ¸…ç†æ€§èƒ½** - ä½¿ç”¨æ—¶é—´è½®ç®—æ³•

---

## ğŸ“ æ€»ç»“

**æ ¸å¿ƒè¯„ä»·**:
è¿™æ˜¯ä¸€ä¸ª**é«˜è´¨é‡çš„å·¥ç¨‹å®ç°**ï¼Œä»£ç è§„èŒƒæ€§ã€èµ„æºç®¡ç†ã€é”™è¯¯å¤„ç†éƒ½è¾¾åˆ°äº†ä¼ä¸šçº§æ ‡å‡†ã€‚æ‰€æœ‰ä¹‹å‰å‘ç°çš„å†…å­˜æ³„æ¼ã€ç«æ€æ¡ä»¶ç­‰é—®é¢˜éƒ½å·²å®Œç¾ä¿®å¤ã€‚

**å”¯ä¸€è‡´å‘½ç¼ºé™·**:
**å…¨å±€ Mutex** å¯¼è‡´æ•´ä¸ªç³»ç»Ÿé€€åŒ–ä¸ºå•çº¿ç¨‹ï¼Œæ— æ³•å‘æŒ¥å¤šç§Ÿæˆ·æ¶æ„çš„ä¼˜åŠ¿ã€‚è¿™ä¸æ˜¯ä»£ç è´¨é‡é—®é¢˜ï¼Œè€Œæ˜¯**æ¶æ„è®¾è®¡å¤±è¯¯**ã€‚

**å»ºè®®**:
ä¿®å¤å…¨å±€ Mutex åï¼Œè¿™å°†æ˜¯ä¸€ä¸ª**ç”Ÿäº§çº§çš„å¤šç§Ÿæˆ· MCP æœåŠ¡å™¨å®ç°**ï¼Œå¯ä»¥æ”¯æ’‘æ•°ç™¾å¹¶å‘ç”¨æˆ·ã€‚

**ä»£ç ä¼˜é›…æ€§**:
ä»£ç å±•ç°äº†æé«˜çš„ä¸“ä¸šç´ å…»ï¼š
- ç§æœ‰å­—æ®µå°è£…ä¸¥æ ¼
- èµ„æºæ¸…ç†æœºåˆ¶å®Œå–„
- æ³¨é‡Šæ¸…æ™°å‡†ç¡®
- é”™è¯¯å¤„ç†ç»†è‡´
- æ€§èƒ½ä¼˜åŒ–åˆ°ä½ï¼ˆå¾ªç¯ç¼“å†²åŒºï¼‰

**æœ€å¤§äº®ç‚¹**:
äº‹ä»¶ç›‘å¬å™¨ç®¡ç†ã€å®šæ—¶å™¨æ¸…ç†ã€è¿­ä»£å™¨å®‰å…¨æ€§ç­‰ç»†èŠ‚å¤„ç†æå…¶ä¸“ä¸šï¼Œå±•ç°äº†å¯¹ JavaScript/TypeScript è¿è¡Œæ—¶çš„æ·±åˆ»ç†è§£ã€‚

**ä¸€å¥è¯è¯„ä»·**:
è¿™æ˜¯ä¸€ä¸ª**åªå·®æœ€åä¸€å…¬é‡Œï¼ˆå…¨å±€Mutexï¼‰çš„ä¼˜ç§€å¤šç§Ÿæˆ·æ¶æ„å®ç°**ã€‚
