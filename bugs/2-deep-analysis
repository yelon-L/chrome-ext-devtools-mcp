# å¤šç§Ÿæˆ·æ¶æ„æ·±åº¦åˆ†æ - æ½œåœ¨é—®é¢˜

## ğŸ”´ ä¸¥é‡é—®é¢˜ï¼ˆCriticalï¼‰

### 1. äº‹ä»¶ç›‘å¬å™¨å†…å­˜æ³„æ¼ (BrowserConnectionPool)

**ä½ç½®**: `src/multi-tenant/core/BrowserConnectionPool.ts:117-119, 370-372`

**é—®é¢˜æè¿°**:
æ¯æ¬¡æµè§ˆå™¨é‡è¿æ—¶éƒ½ä¼šæ·»åŠ æ–°çš„ `disconnected` äº‹ä»¶ç›‘å¬å™¨ï¼Œä½†æ—§çš„ç›‘å¬å™¨ä»æœªè¢«ç§»é™¤ã€‚å¦‚æœæµè§ˆå™¨é¢‘ç¹æ–­å¼€é‡è¿ï¼Œç›‘å¬å™¨ä¼šä¸æ–­ç´¯ç§¯ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼å’Œæ€§èƒ½ä¸‹é™ã€‚

**å½“å‰ä»£ç **:
```typescript
// é¦–æ¬¡è¿æ¥ - L117
browser.on('disconnected', () => {
  this.#handleDisconnect(browserId);
});

// é‡è¿æˆåŠŸ - L370
browser.on('disconnected', () => {
  this.#handleDisconnect(browserId);
});
```

**é—®é¢˜**:
- æ—§çš„æµè§ˆå™¨å®ä¾‹è¢«æ›¿æ¢ï¼Œä½†äº‹ä»¶ç›‘å¬å™¨ä»åœ¨å†…å­˜ä¸­
- æ¯æ¬¡é‡è¿éƒ½ä¼šæ–°å¢ä¸€ä¸ªç›‘å¬å™¨
- å¯èƒ½å¯¼è‡´åŒä¸€ä¸ªæ–­å¼€äº‹ä»¶è¢«å¤„ç†å¤šæ¬¡

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
// åœ¨ connect() æ–¹æ³•ä¸­
const disconnectHandler = () => {
  this.#handleDisconnect(browserId);
};
browser.once('disconnected', disconnectHandler); // ä½¿ç”¨ once è‡ªåŠ¨ç§»é™¤

// æˆ–è€…åœ¨é‡è¿å‰å…ˆç§»é™¤æ—§ç›‘å¬å™¨
async #reconnect(browserId: string): Promise<void> {
  const connection = this.#connections.get(browserId);
  if (!connection) return;
  
  // ç§»é™¤æ—§æµè§ˆå™¨çš„ç›‘å¬å™¨
  const oldBrowser = connection.browser;
  if (oldBrowser) {
    oldBrowser.removeAllListeners('disconnected');
  }
  
  // ... é‡è¿é€»è¾‘ ...
  
  const browser = await this.#connectWithTimeout(connection.browserURL);
  connection.browser = browser;
  
  // æ·»åŠ æ–°ç›‘å¬å™¨
  browser.once('disconnected', () => {
    this.#handleDisconnect(browserId);
  });
}
```

**å½±å“**:
- å†…å­˜æ³„æ¼ï¼šæ¯æ¬¡é‡è¿å¢åŠ  ~1KB å†…å­˜
- æ€§èƒ½ä¸‹é™ï¼šæ–­å¼€äº‹ä»¶å¯èƒ½è§¦å‘å¤šæ¬¡å¤„ç†
- æ—¥å¿—é‡å¤ï¼šåŒä¸€æ–­å¼€äº‹ä»¶è¢«è®°å½•å¤šæ¬¡

---

### 2. BrowserConnectionPool.disconnect() æœªæ¸…ç†äº‹ä»¶ç›‘å¬å™¨

**ä½ç½®**: `src/multi-tenant/core/BrowserConnectionPool.ts:135-158`

**é—®é¢˜æè¿°**:
æ–­å¼€è¿æ¥æ—¶ç›´æ¥è°ƒç”¨ `browser.close()`ï¼Œä½†æ²¡æœ‰å…ˆç§»é™¤äº‹ä»¶ç›‘å¬å™¨ã€‚è¿™å¯èƒ½å¯¼è‡´ï¼š
- æµè§ˆå™¨å…³é—­åè§¦å‘ `disconnected` äº‹ä»¶
- è°ƒç”¨ `#handleDisconnect()` å°è¯•é‡è¿å·²å…³é—­çš„æµè§ˆå™¨
- è§¦å‘ä¸å¿…è¦çš„é‡è¿é€»è¾‘

**å½“å‰ä»£ç **:
```typescript
async disconnect(userId: string): Promise<boolean> {
  const browserId = this.#userConnections.get(userId);
  if (!browserId) return false;

  const connection = this.#connections.get(browserId);
  if (!connection) return false;

  try {
    await connection.browser.close(); // âŒ ç›´æ¥å…³é—­ï¼Œæ²¡æœ‰æ¸…ç†ç›‘å¬å™¨
  } catch (error) {
    logger(`[BrowserConnectionPool] å…³é—­æµè§ˆå™¨å¤±è´¥: ${error}`);
  }

  this.#connections.delete(browserId);
  this.#userConnections.delete(userId);
  
  return true;
}
```

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
async disconnect(userId: string): Promise<boolean> {
  const browserId = this.#userConnections.get(userId);
  if (!browserId) return false;

  const connection = this.#connections.get(browserId);
  if (!connection) return false;

  try {
    // å…ˆç§»é™¤äº‹ä»¶ç›‘å¬å™¨ï¼Œé˜²æ­¢è§¦å‘é‡è¿
    connection.browser.removeAllListeners('disconnected');
    
    // å†å…³é—­æµè§ˆå™¨
    await connection.browser.close();
  } catch (error) {
    logger(`[BrowserConnectionPool] å…³é—­æµè§ˆå™¨å¤±è´¥: ${error}`);
  }

  this.#connections.delete(browserId);
  this.#userConnections.delete(userId);
  
  return true;
}
```

---

### 3. cleanupUserSessions çš„è¿­ä»£å™¨å¤±æ•ˆé—®é¢˜

**ä½ç½®**: `src/multi-tenant/core/SessionManager.ts:211-225`

**é—®é¢˜æè¿°**:
åœ¨è¿­ä»£ `Set<string>` æ—¶å¹¶å‘åˆ é™¤ä¼šè¯ï¼Œä¼šå¯¼è‡´ `deleteSession` å†…éƒ¨ä¿®æ”¹åŒä¸€ä¸ª Setï¼Œé€ æˆè¿­ä»£å™¨å¤±æ•ˆæˆ–é—æ¼åˆ é™¤ã€‚

**å½“å‰ä»£ç **:
```typescript
async cleanupUserSessions(userId: string): Promise<void> {
  const sessionIds = this.#userSessions.get(userId);
  if (!sessionIds) return;

  const deletePromises: Promise<boolean>[] = [];
  // âš ï¸ æ­£åœ¨è¿­ä»£ sessionIds Set
  for (const sessionId of sessionIds) {
    deletePromises.push(this.deleteSession(sessionId));
    // â¬†ï¸ deleteSession å†…éƒ¨ä¼šä¿®æ”¹ sessionIds Set (L171)
  }

  await Promise.all(deletePromises);
}
```

**ç«æ€æ¡ä»¶**:
```typescript
// SessionManager.ts L169-174
const userSessions = this.#userSessions.get(session.userId);
if (userSessions) {
  userSessions.delete(sessionId); // âš ï¸ ä¿®æ”¹æ­£åœ¨è¢«è¿­ä»£çš„ Set
  if (userSessions.size === 0) {
    this.#userSessions.delete(session.userId);
  }
}
```

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
async cleanupUserSessions(userId: string): Promise<void> {
  const sessionIds = this.#userSessions.get(userId);
  if (!sessionIds) return;

  // 1. å…ˆå¤åˆ¶ä¸€ä»½ï¼Œé¿å…è¿­ä»£æ—¶ä¿®æ”¹
  const sessionIdsCopy = Array.from(sessionIds);

  const deletePromises: Promise<boolean>[] = [];
  for (const sessionId of sessionIdsCopy) {
    deletePromises.push(this.deleteSession(sessionId));
  }

  await Promise.all(deletePromises);
  logger(`[SessionManager] ç”¨æˆ·ä¼šè¯å·²æ¸…ç†: ${userId}`);
}
```

---

## ğŸŸ¡ ä¸­ç­‰é—®é¢˜ï¼ˆMajorï¼‰

### 4. BrowserConnectionPool.connect() çš„ TOCTOU ç«æ€

**ä½ç½®**: `src/multi-tenant/core/BrowserConnectionPool.ts:81-90`

**é—®é¢˜æè¿°**:
æ£€æŸ¥è¿æ¥çŠ¶æ€å’Œä½¿ç”¨è¿æ¥ä¹‹é—´å­˜åœ¨æ—¶é—´çª—å£ï¼ˆTOCTOU: Time-Of-Check-Time-Of-Useï¼‰ï¼Œå¯èƒ½å¯¼è‡´è¿”å›å·²æ–­å¼€çš„æµè§ˆå™¨å®ä¾‹ã€‚

**å½“å‰ä»£ç **:
```typescript
async connect(userId: string, browserURL: string): Promise<Browser> {
  const existingBrowserId = this.#userConnections.get(userId);
  if (existingBrowserId) {
    const connection = this.#connections.get(existingBrowserId);
    // âš ï¸ æ£€æŸ¥æ—¶æ˜¯ connected
    if (connection && connection.status === 'connected') {
      logger(`[BrowserConnectionPool] å¤ç”¨ç°æœ‰è¿æ¥: ${userId}`);
      return connection.browser; // âš ï¸ è¿”å›æ—¶å¯èƒ½å·²æ–­å¼€
    }
  }
  // ... åˆ›å»ºæ–°è¿æ¥
}
```

**åœºæ™¯**:
1. T1: æ£€æŸ¥ `connection.status === 'connected'` âœ…
2. T2: æµè§ˆå™¨æ–­å¼€ï¼Œ`#handleDisconnect()` å°†çŠ¶æ€æ”¹ä¸º `disconnected`
3. T3: è¿”å› `connection.browser`ï¼ˆå·²æ–­å¼€çš„å®ä¾‹ï¼‰

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
async connect(userId: string, browserURL: string): Promise<Browser> {
  const existingBrowserId = this.#userConnections.get(userId);
  if (existingBrowserId) {
    const connection = this.#connections.get(existingBrowserId);
    if (connection && connection.status === 'connected') {
      // åŒé‡æ£€æŸ¥ï¼šéªŒè¯æµè§ˆå™¨å®é™…è¿æ¥çŠ¶æ€
      if (connection.browser.isConnected()) {
        logger(`[BrowserConnectionPool] å¤ç”¨ç°æœ‰è¿æ¥: ${userId}`);
        return connection.browser;
      } else {
        // çŠ¶æ€ä¸ä¸€è‡´ï¼Œæ ‡è®°ä¸ºæ–­å¼€
        logger(`[BrowserConnectionPool] æ£€æµ‹åˆ°è¿æ¥çŠ¶æ€ä¸ä¸€è‡´: ${userId}`);
        connection.status = 'disconnected';
      }
    }
  }
  
  // åˆ›å»ºæ–°è¿æ¥...
}
```

---

### 5. ç»Ÿè®¡æ•°æ®çš„éåŸå­æ“ä½œ

**ä½ç½®**: `src/multi-tenant/server-multi-tenant.ts:53-58`

**é—®é¢˜æè¿°**:
å¤šä¸ªå¹¶å‘è¯·æ±‚åŒæ—¶ä¿®æ”¹ç»Ÿè®¡æ•°æ®ï¼Œå¯èƒ½å¯¼è‡´è®¡æ•°ä¸å‡†ç¡®ã€‚è™½ç„¶å½±å“ä¸å¤§ï¼Œä½†åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ä¼šç´¯ç§¯è¯¯å·®ã€‚

**å½“å‰ä»£ç **:
```typescript
private stats = {
  totalConnections: 0,      // âš ï¸ éåŸå­é€’å¢
  totalRequests: 0,         // âš ï¸ éåŸå­é€’å¢
  totalErrors: 0,           // âš ï¸ éåŸå­é€’å¢
  connectionTimes: [] as number[],
};

// å¤šå¤„å¹¶å‘ä¿®æ”¹
this.stats.totalConnections++;  // âš ï¸ ç«æ€æ¡ä»¶
this.stats.totalErrors++;
```

**é—®é¢˜**:
JavaScript çš„ `++` æ“ä½œä¸æ˜¯åŸå­çš„ï¼š
1. è¯»å–å€¼
2. åŠ  1
3. å†™å›

å¤šä¸ªå¹¶å‘è¯·æ±‚å¯èƒ½å¯¼è‡´"ä¸¢å¤±æ›´æ–°"ã€‚

**ä¿®å¤å»ºè®®**ï¼ˆä¸¤ç§æ–¹æ¡ˆï¼‰:

**æ–¹æ¡ˆ 1: ä½¿ç”¨ Atomicsï¼ˆæ€§èƒ½æœ€ä½³ï¼‰**
```typescript
private statsBuffer = new SharedArrayBuffer(16); // 4 ä¸ª Int32
private stats = {
  totalConnections: new Int32Array(this.statsBuffer, 0, 1),
  totalRequests: new Int32Array(this.statsBuffer, 4, 1),
  totalErrors: new Int32Array(this.statsBuffer, 8, 1),
};

// åŸå­é€’å¢
Atomics.add(this.stats.totalConnections, 0, 1);
```

**æ–¹æ¡ˆ 2: æ¥å—è¯¯å·®ï¼ˆæ¨èï¼‰**
```typescript
// æ·»åŠ æ³¨é‡Šè¯´æ˜
/**
 * æ€§èƒ½ç»Ÿè®¡ï¼ˆéåŸå­æ“ä½œï¼Œé«˜å¹¶å‘ä¸‹å¯èƒ½æœ‰è½»å¾®è¯¯å·®ï¼‰
 * ç”±äºå½±å“ä¸å¤§ï¼Œä¸ºæ€§èƒ½è€ƒè™‘ä¸ä½¿ç”¨é”
 */
private stats = {
  totalConnections: 0,
  totalRequests: 0,
  totalErrors: 0,
};
```

---

### 6. #connectWithTimeout çš„å®šæ—¶å™¨æ³„æ¼

**ä½ç½®**: `src/multi-tenant/core/BrowserConnectionPool.ts:385-394`

**é—®é¢˜æè¿°**:
å¦‚æœ `puppeteer.connect()` å…ˆå®Œæˆï¼Œ`setTimeout` åˆ›å»ºçš„å®šæ—¶å™¨ä¸ä¼šè¢«æ¸…é™¤ï¼Œä¼šä¸€ç›´ç­‰åˆ°è¶…æ—¶æ‰é”€æ¯ã€‚

**å½“å‰ä»£ç **:
```typescript
async #connectWithTimeout(browserURL: string): Promise<Browser> {
  return Promise.race([
    puppeteer.connect({ browserURL }),
    new Promise<Browser>((_, reject) =>
      setTimeout(
        () => reject(new Error('è¿æ¥è¶…æ—¶')),
        this.#config.connectionTimeout  // âš ï¸ å®šæ—¶å™¨æœªæ¸…ç†
      )
    ),
  ]);
}
```

**å½±å“**:
- å®šæ—¶å™¨ä¼šåœ¨å †ä¸Šä¿ç•™å¼•ç”¨ï¼Œç›´åˆ°è§¦å‘
- é¢‘ç¹è¿æ¥ä¼šç´¯ç§¯å¤§é‡å¾…è§¦å‘çš„å®šæ—¶å™¨
- å†…å­˜å ç”¨å¢åŠ 

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
async #connectWithTimeout(browserURL: string): Promise<Browser> {
  let timeoutId: NodeJS.Timeout;
  
  return Promise.race([
    puppeteer.connect({ browserURL }).finally(() => {
      clearTimeout(timeoutId); // è¿æ¥æˆåŠŸæ—¶æ¸…ç†
    }),
    new Promise<Browser>((_, reject) => {
      timeoutId = setTimeout(
        () => reject(new Error('è¿æ¥è¶…æ—¶')),
        this.#config.connectionTimeout
      );
    }),
  ]);
}
```

---

### 7. handleSSE è¶…æ—¶å¤„ç†çš„ç«æ€æ¡ä»¶

**ä½ç½®**: `src/multi-tenant/server-multi-tenant.ts:538-549`

**é—®é¢˜æè¿°**:
è¶…æ—¶å®šæ—¶å™¨å’Œæ­£å¸¸è¿æ¥å®Œæˆä¹‹é—´å­˜åœ¨ç«æ€ï¼Œå¯èƒ½å¯¼è‡´å“åº”è¢«å‘é€ä¸¤æ¬¡ã€‚

**å½“å‰ä»£ç **:
```typescript
const timeout = setTimeout(() => {
  this.stats.totalErrors++;
  logger(`[Server] â° è¿æ¥è¶…æ—¶: ${userId}`);
  if (!res.headersSent) {  // âš ï¸ æ£€æŸ¥å’Œå‘é€ä¹‹é—´æœ‰æ—¶é—´çª—å£
    res.writeHead(504, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({...}));
  }
}, 30000);

try {
  // ... è¿æ¥é€»è¾‘ ...
  clearTimeout(timeout);  // âš ï¸ å¯èƒ½å·²ç»è§¦å‘
} catch (error) {
  clearTimeout(timeout);
}
```

**ç«æ€åœºæ™¯**:
1. T1: è¿æ¥è€—æ—¶ 29.999 ç§’ï¼Œå³å°†å®Œæˆ
2. T2: è¶…æ—¶å®šæ—¶å™¨è§¦å‘ï¼Œæ£€æŸ¥ `!res.headersSent` âœ…
3. T3: è¿æ¥æˆåŠŸï¼Œå‘é€å“åº”
4. T4: è¶…æ—¶å¤„ç†å‘é€å“åº” â†’ å´©æºƒï¼ˆCannot set headers after sentï¼‰

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
private async establishConnection(...): Promise<void> {
  let isTimedOut = false;
  const timeout = setTimeout(() => {
    isTimedOut = true;  // æ ‡è®°è¶…æ—¶
    this.stats.totalErrors++;
    logger(`[Server] â° è¿æ¥è¶…æ—¶: ${userId}`);
    if (!res.headersSent) {
      res.writeHead(504, { 'Content-Type': 'application/json' });
      res.end(JSON.stringify({...}));
    }
  }, 30000);

  try {
    // è¿æ¥å‰æ£€æŸ¥æ˜¯å¦å·²è¶…æ—¶
    if (isTimedOut) {
      throw new Error('Connection timed out before start');
    }
    
    const browser = await this.browserPool.connect(userId, browserURL);
    
    // è¿æ¥æˆåŠŸåç«‹å³æ£€æŸ¥
    if (isTimedOut) {
      // è¶…æ—¶å·²è§¦å‘ï¼Œæ¸…ç†èµ„æº
      await this.browserPool.disconnect(userId);
      return;
    }
    
    // ... å…¶ä½™é€»è¾‘ ...
    clearTimeout(timeout);
  } catch (error) {
    clearTimeout(timeout);
    if (!isTimedOut && !res.headersSent) {
      // åªåœ¨æœªè¶…æ—¶æ—¶å‘é€é”™è¯¯å“åº”
      res.writeHead(500, {...});
      res.end(...);
    }
    throw error;
  }
}
```

---

## ğŸŸ¢ ä½ä¼˜å…ˆçº§é—®é¢˜ï¼ˆMinorï¼‰

### 8. RouterManager.registerUser æ— å¹¶å‘ä¿æŠ¤

**ä½ç½®**: `src/multi-tenant/core/RouterManager.ts:31-61`

**é—®é¢˜æè¿°**:
åŒä¸€ç”¨æˆ·å¹¶å‘æ³¨å†Œæ—¶ï¼Œå¯èƒ½äº§ç”Ÿä¸ä¸€è‡´çš„çŠ¶æ€ï¼ˆè™½ç„¶å®é™…å½±å“å¾ˆå°ï¼‰ã€‚

**åœºæ™¯**:
```
Request 1: POST /api/register userId=user-1, browserURL=http://A:9222
Request 2: POST /api/register userId=user-1, browserURL=http://B:9222
```

å¹¶å‘æ‰§è¡Œå¯èƒ½å¯¼è‡´ä¸ç¡®å®šçš„æœ€ç»ˆçŠ¶æ€ã€‚

**å»ºè®®**: å¦‚éœ€ä¸¥æ ¼ä¸€è‡´æ€§ï¼Œæ·»åŠ ç”¨æˆ·çº§é”ï¼š
```typescript
private registerLocks = new Map<string, Promise<void>>();

async registerUser(userId: string, browserURL: string, metadata?: UserMetadata): Promise<void> {
  // ç­‰å¾…å·²æœ‰çš„æ³¨å†Œæ“ä½œå®Œæˆ
  const existingLock = this.registerLocks.get(userId);
  if (existingLock) {
    await existingLock;
  }
  
  const lock = (async () => {
    // éªŒè¯å’Œæ³¨å†Œé€»è¾‘...
  })();
  
  this.registerLocks.set(userId, lock);
  try {
    await lock;
  } finally {
    this.registerLocks.delete(userId);
  }
}
```

---

### 9. cleanupExpiredSessions çš„æ€§èƒ½é—®é¢˜

**ä½ç½®**: `src/multi-tenant/core/SessionManager.ts:230-251`

**é—®é¢˜æè¿°**:
æ¯åˆ†é’Ÿéå†æ‰€æœ‰ä¼šè¯æ£€æŸ¥è¿‡æœŸï¼Œåœ¨å¤§é‡ä¼šè¯æ—¶ï¼ˆ>10000ï¼‰æ€§èƒ½è¾ƒå·®ã€‚

**å½“å‰å®ç°**: O(n) æ—¶é—´å¤æ‚åº¦

**ä¼˜åŒ–å»ºè®®**: ä½¿ç”¨æœ€å°å †æˆ–æ—¶é—´è½®ç®—æ³•
```typescript
// ä½¿ç”¨æŒ‰è¿‡æœŸæ—¶é—´æ’åºçš„ä¼˜å…ˆé˜Ÿåˆ—
private expiryQueue = new PriorityQueue<{sessionId: string, expiryTime: number}>();

createSession(...) {
  // åˆ›å»ºä¼šè¯æ—¶å…¥é˜Ÿ
  const expiryTime = Date.now() + this.#config.timeout;
  this.expiryQueue.push({sessionId, expiryTime});
}

async cleanupExpiredSessions(): Promise<void> {
  const now = Date.now();
  const expiredSessions: string[] = [];
  
  // åªæ£€æŸ¥é˜Ÿé¦–å…ƒç´ ï¼Œç›´åˆ°é‡åˆ°æœªè¿‡æœŸçš„
  while (!this.expiryQueue.isEmpty() && this.expiryQueue.peek().expiryTime < now) {
    const {sessionId} = this.expiryQueue.pop();
    if (this.#sessions.has(sessionId)) {
      expiredSessions.push(sessionId);
    }
  }
  
  // æ‰¹é‡åˆ é™¤
  await Promise.all(expiredSessions.map(id => this.deleteSession(id)));
}
```

---

### 10. JSON.parse ç¼ºå°‘é”™è¯¯å¤„ç†

**ä½ç½®**: å¤šå¤„ JSON è§£æ

**é—®é¢˜ç¤ºä¾‹**:
```typescript
// server-multi-tenant.ts L687
const message = JSON.parse(body);  // âš ï¸ å¯èƒ½æŠ›å‡º SyntaxError
```

**ä¿®å¤å»ºè®®**:
```typescript
try {
  const message = JSON.parse(body);
  await session.transport.handlePostMessage(req, res, message);
} catch (error) {
  if (error instanceof SyntaxError) {
    // å®¢æˆ·ç«¯é”™è¯¯
    res.writeHead(400, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({ error: 'Invalid JSON' }));
  } else {
    // æœåŠ¡ç«¯é”™è¯¯
    throw error;
  }
}
```

---

## æ€»ç»“

### é—®é¢˜ä¸¥é‡æ€§åˆ†å¸ƒ

| ä¸¥é‡æ€§ | æ•°é‡ | é—®é¢˜ |
|-------|-----|------|
| ğŸ”´ Critical | 3 | äº‹ä»¶ç›‘å¬å™¨æ³„æ¼ã€è¿­ä»£å™¨å¤±æ•ˆã€disconnect æœªæ¸…ç†ç›‘å¬å™¨ |
| ğŸŸ¡ Major | 5 | TOCTOU ç«æ€ã€ç»Ÿè®¡éåŸå­ã€å®šæ—¶å™¨æ³„æ¼ã€è¶…æ—¶ç«æ€ã€JSON é”™è¯¯å¤„ç† |
| ğŸŸ¢ Minor | 2 | å¹¶å‘æ³¨å†Œä¿æŠ¤ã€æ¸…ç†æ€§èƒ½ |

### ä¿®å¤ä¼˜å…ˆçº§å»ºè®®

**Phase 1 (ç«‹å³ä¿®å¤)**:
1. ä¿®å¤äº‹ä»¶ç›‘å¬å™¨æ³„æ¼ï¼ˆé—®é¢˜ 1ã€2ï¼‰
2. ä¿®å¤ cleanupUserSessions è¿­ä»£å™¨é—®é¢˜ï¼ˆé—®é¢˜ 3ï¼‰

**Phase 2 (çŸ­æœŸä¿®å¤)**:
3. æ·»åŠ  TOCTOU åŒé‡æ£€æŸ¥ï¼ˆé—®é¢˜ 4ï¼‰
4. ä¿®å¤ connectWithTimeout å®šæ—¶å™¨æ³„æ¼ï¼ˆé—®é¢˜ 6ï¼‰
5. å®Œå–„ JSON è§£æé”™è¯¯å¤„ç†ï¼ˆé—®é¢˜ 10ï¼‰

**Phase 3 (ä¸­æœŸä¼˜åŒ–)**:
6. å¤„ç† establishConnection è¶…æ—¶ç«æ€ï¼ˆé—®é¢˜ 7ï¼‰
7. æ”¹è¿›ç»Ÿè®¡æ•°æ®ä¸€è‡´æ€§ï¼ˆé—®é¢˜ 5ï¼‰

**Phase 4 (é•¿æœŸä¼˜åŒ–)**:
8. ä¼˜åŒ–è¿‡æœŸæ¸…ç†æ€§èƒ½ï¼ˆé—®é¢˜ 9ï¼‰
9. æ·»åŠ æ³¨å†Œå¹¶å‘ä¿æŠ¤ï¼ˆé—®é¢˜ 8ï¼‰

### æµ‹è¯•å»ºè®®

é’ˆå¯¹è¿™äº›é—®é¢˜ï¼Œå»ºè®®è¡¥å……ä»¥ä¸‹æµ‹è¯•ï¼š

1. **å‹åŠ›æµ‹è¯•**: æ¨¡æ‹Ÿ 100+ å¹¶å‘è¿æ¥ï¼Œæ£€æŸ¥å†…å­˜å¢é•¿
2. **é•¿æ—¶é—´è¿è¡Œæµ‹è¯•**: 24 å°æ—¶æµ‹è¯•ï¼Œç›‘æ§äº‹ä»¶ç›‘å¬å™¨æ•°é‡
3. **æ–­ç½‘æ¢å¤æµ‹è¯•**: éªŒè¯é‡è¿æœºåˆ¶çš„ç¨³å®šæ€§
4. **å¹¶å‘æ³¨å†Œæµ‹è¯•**: éªŒè¯å¤šç”¨æˆ·å¹¶å‘æ³¨å†Œçš„ä¸€è‡´æ€§
5. **å¼‚å¸¸è¾¹ç•Œæµ‹è¯•**: å„ç§é”™è¯¯è¾“å…¥å’Œç½‘ç»œå¼‚å¸¸åœºæ™¯
